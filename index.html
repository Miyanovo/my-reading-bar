<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„ä¸–ç•Œé˜…è¯»è®°å½• - æ˜Ÿä¹‹æœå®é¤å§ç‰ˆ</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=VT323&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <style>
        /* --- ğŸ¨ åŸºç¡€é…è‰² --- */
        :root {
            --primary-color: #7cb342; 
            --bg-main: #cbe3f7;
            --bg-panel: #ffffff;
            --text-dark: #5d4037;      
            
            /* ğŸ” æ˜Ÿéœ²è°·ç”°å›­é£ä¸“ç”¨å˜é‡ */
            --sdv-wood-dark: #4a2810;  /* æ·±æœ¨è‰² */
            --sdv-wood-light: #e0a663; /* æµ…æœ¨è‰² */
            --sdv-blue-ui: #2d3690;    /* UIæ·±è“èƒŒæ™¯ */
            --sdv-cream: #ffefcd;      /* çº¸å¼ å¥¶æ²¹è‰² */
            --sdv-border-gold: #f8b32e;/* é‡‘è‰²è¾¹æ¡† */
            --sdv-green: #48a826;      /* æˆåŠŸç»¿ */
            --sdv-red: #e63e3e;        /* æŒ‰é’®çº¢ */
            --sdv-text-brown: #3f1807; /* ä¸»è¦æ–‡å­—è¤ */
            
            /* åƒç´ è¾¹æ¡†æ¨¡æ‹Ÿ */
            --pixel-box-shadow: 
                inset 3px 3px 0px rgba(255,255,255,0.2),
                inset -3px -3px 0px rgba(0,0,0,0.3),
                3px 0px 0px #000, -3px 0px 0px #000, 
                0px 3px 0px #000, 0px -3px 0px #000;
        }

        /* åŸºç¡€æ ·å¼ */
        body { margin: 0; padding: 0; background-color: var(--bg-main); font-family: "Microsoft YaHei", sans-serif; display: flex; height: 100vh; overflow: hidden; transition: background-color 0.5s ease; }
        #left-stage { flex: 1; position: relative; width: 100%; height: 100%; overflow: hidden; }
        #map-container { width: 100%; height: 100%; position: absolute; top:0; left:0; z-index: 1; transition: opacity 0.5s ease, transform 0.5s ease; opacity: 1; transform: scale(1); visibility: visible; }
        #main { width: 100%; height: 100%; }

        /* =========================================
           ğŸº æ˜Ÿä¹‹æœå®é¤å§ UI å±‚
           ========================================= */
        #bar-interface {
            width: 100%; height: 100%; position: absolute; top:0; left:0; z-index: 10;
            background-color: #2a1d2a; 
            display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
            opacity: 0; visibility: hidden; pointer-events: none; transform: scale(1.1);
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            color: var(--sdv-text-brown); padding-top: 20px; box-sizing: border-box;
            font-family: 'VT323', monospace; 
            overflow: hidden; 
        }

        /* ğŸŒ² èƒŒæ™¯å›¾ç‰‡å±‚ (70%é€æ˜åº¦) */
        #bar-interface::before {
            content: "";
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image: url('8766400c5c1bdb4a4b48b00aedb331d.jpg'); 
            background-size: cover;
            background-position: center;
            opacity: 0.3; 
            z-index: -1;
            filter: blur(2px) brightness(0.6); 
        }

        body.bar-mode #map-container { opacity: 0; transform: scale(0.9); visibility: hidden; }
        body.bar-mode #bar-interface { opacity: 1; visibility: visible; pointer-events: auto; transform: scale(1); }

        /* å¯¼èˆªæ  */
        .bar-nav { display: flex; gap: 10px; margin-bottom: 20px; z-index: 20; background: #6b4322; padding: 10px; border-radius: 10px; border: 3px solid #3c1e0a; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        .bar-nav-item {
            padding: 10px 20px; 
            background: var(--sdv-wood-light);
            color: var(--sdv-text-brown);
            cursor: pointer; font-size: 20px; 
            font-family: 'Press Start 2P', 'SimSun', monospace; 
            font-weight: bold;
            letter-spacing: 2px;
            border: 2px solid #593111;
            box-shadow: inset 0 -4px 0 rgba(0,0,0,0.2);
            transition: transform 0.1s;
            text-transform: uppercase;
            border-radius: 4px;
        }
        .bar-nav-item:hover { transform: translateY(-2px); filter: brightness(1.1); }
        .bar-nav-item:active { transform: translateY(2px); box-shadow: none; }
        .bar-nav-item.active {
            background: var(--sdv-red);
            color: #fff;
            border-color: #7a1515;
            text-shadow: 2px 2px 0 #333;
        }

        /* å†…å®¹å®¹å™¨ */
        .bar-content { 
            width: 90%; max-width: 700px; flex: 1; 
            background: var(--sdv-blue-ui);
            border: 4px solid var(--sdv-border-gold);
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5), inset 0 0 50px rgba(0,0,0,0.2);
            display: flex; flex-direction: column; align-items: center; 
            overflow-y: auto; position: relative; padding: 20px;
            margin-bottom: 30px;
        }
        
        .bar-content::-webkit-scrollbar { width: 12px; }
        .bar-content::-webkit-scrollbar-track { background: #1c2363; }
        .bar-content::-webkit-scrollbar-thumb { background: var(--sdv-border-gold); border-radius: 6px; border: 2px solid #1c2363; }

        .bar-view { display: none; width: 100%; flex-direction: column; align-items: center; animation: fadeIn 0.4s; }
        .bar-view.active { display: flex; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* æ ‡é¢˜ */
        .neon-sign {
            font-family: 'Press Start 2P', cursive;
            font-size: 1.8rem; color: #fff;
            text-shadow: 3px 3px 0 #000, -1px -1px 0 #2a1d42;
            margin-bottom: 20px; line-height: 1.5; text-align: center;
            background: linear-gradient(to bottom, #74a7f7, #3144b5);
            -webkit-background-clip: text;
            margin-top: 40px;
        }

        /* æŒ‰é’® */
        .random-btn, .produce-btn {
            margin-top: 30px; width: 200px; padding: 15px;
            background: var(--sdv-green);
            border: none;
            color: #fff;
            font-family: 'Press Start 2P', 'SimSun', monospace;
            font-size: 16px; cursor: pointer;
            box-shadow: var(--pixel-box-shadow);
            transition: all 0.1s;
            text-shadow: 2px 2px 0 #333;
            border-radius: 4px;
        }
        .random-btn:hover, .produce-btn:hover { transform: scale(1.05); filter: brightness(1.1); }
        .random-btn:active, .produce-btn:active { transform: scale(0.95); box-shadow: inset 0 0 10px rgba(0,0,0,0.5); }

        /* ç­›é€‰é¢æ¿ */
        .filter-group {
            background: var(--sdv-cream); 
            padding: 15px; margin-bottom: 15px; width: 90%; 
            border: 2px solid #cfaa74;
            border-radius: 8px;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
            position: relative;
        }
        .filter-title { color: var(--sdv-text-brown); font-size: 18px; margin-bottom: 10px; display: block; font-weight: bold; font-family: 'Press Start 2P', 'SimSun'; font-size: 12px;}
        .filter-options { display: flex; gap: 8px; flex-wrap: wrap; }
        .filter-opt {
            padding: 5px 10px; border: 2px solid #d4bba3; font-size: 16px;
            cursor: pointer; color: #777; transition: 0.1s; background: #fff;
            border-radius: 4px;
            font-family: 'SimSun', monospace;
        }
        .filter-opt:hover { border-color: var(--sdv-wood-light); color: var(--sdv-text-brown); }
        .filter-opt.selected { 
            background: var(--sdv-wood-light); 
            border-color: #8c5828; 
            color: #fff; text-shadow: 1px 1px 0 #333;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.2);
        }

        /* =========================================
           ğŸ“¦ åˆ†ç»„ä¸æ‹–æ‹½ç³»ç»Ÿ (Inventory)
           ========================================= */
        .fav-groups-container {
            width: 100%; display: flex; flex-direction: column; gap: 20px; padding: 10px; box-sizing: border-box;
        }
        .fav-group {
            background: rgba(0,0,0,0.2);
            border: 2px dashed #8c5828;
            border-radius: 8px;
            padding: 10px;
            position: relative;
            min-height: 100px;
            transition: background 0.2s, border-color 0.2s;
        }
        /* æ‹–æ‹½ç»è¿‡æ—¶çš„é«˜äº®æ•ˆæœ */
        .fav-group.drag-over {
            background: rgba(72, 168, 38, 0.3); 
            border-style: solid;
            border-color: var(--sdv-green);
        }
        .group-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 10px; padding: 0 5px;
        }
        .group-title {
            font-family: 'Press Start 2P', 'SimSun';
            color: #ffefcd; 
            text-shadow: 1px 1px 0 #3f1807;
            font-size: 14px; cursor: pointer;
            border-bottom: 1px dashed transparent;
            padding-bottom: 2px;
        }
        .group-title:hover { border-bottom-color: #ffefcd; }
        .group-title::after { content: ' âœ'; font-size: 10px; color: #ccc; opacity: 0; }
        .group-title:hover::after { opacity: 1; }
        
        .group-delete-btn { font-size: 12px; cursor: pointer; color: #e63e3e; font-family: 'SimSun', sans-serif; font-weight: bold;}
        .group-delete-btn:hover { color: #ff6b6b; text-decoration: underline; }

        .add-group-btn {
            width: 100%; padding: 12px;
            border: 2px dashed #e0a663;
            color: #e0a663; cursor: pointer;
            font-family: 'Press Start 2P', 'SimSun';
            text-align: center; background: transparent;
            transition: 0.2s; margin-top: 10px; border-radius: 8px;
        }
        .add-group-btn:hover { background: rgba(224, 166, 99, 0.1); color: #fff; border-color: #fff;}

        /* é…’çª–æ ¼å­ (æ‹–æ‹½é¡¹) */
        .fav-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; width: 100%; }
        .fav-item {
            background: var(--sdv-wood-dark); 
            border: 2px solid #3c1e0a; 
            padding: 8px; border-radius: 8px;
            cursor: grab; transition: 0.2s; display: flex; flex-direction: column; align-items: center;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
        }
        .fav-item:active { cursor: grabbing; transform: scale(0.95); }
        .fav-item:hover { transform: translateY(-3px); box-shadow: 0 5px 10px rgba(0,0,0,0.5); border-color: var(--sdv-border-gold); }
        .fav-icon { font-size: 24px; margin-bottom: 5px; }
        .fav-name { color: #fff; font-size: 12px; text-shadow: 1px 1px 0 #000; overflow: hidden; text-overflow: ellipsis; width: 100%; text-align: center; font-family: 'VT323';}

        /* é¥®å“å¡å¼¹çª— */
        .drink-card-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(2px);
            display: flex; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s; z-index: 50;
        }
        .drink-card-overlay.show { opacity: 1; pointer-events: auto; }
        
        .drink-card {
            background: var(--sdv-cream);
            width: 360px; padding: 25px;
            border: 4px solid var(--sdv-text-brown);
            border-radius: 2px;
            position: relative; 
            box-shadow: 10px 10px 0px rgba(0,0,0,0.4);
            text-align: center; color: var(--sdv-text-brown);
            transform: translateY(20px); transition: transform 0.3s;
            font-family: 'VT323', monospace;
        }
        .drink-card::before {
            content: ''; position: absolute; top: 5px; left: 5px; right: 5px; bottom: 5px;
            border: 2px dashed #d4bba3; pointer-events: none;
        }

        .drink-card-overlay.show .drink-card { transform: translateY(0); }
        
        .card-close { 
            position: absolute; top: 10px; right: 15px; font-size: 24px; cursor: pointer; color: var(--sdv-red); 
            font-family: 'Press Start 2P'; z-index: 2;
        }
        .card-close:hover { transform: scale(1.2); }
        
        /* ğŸ·ï¸ ä¾§è¾¹æ ‡ç­¾ (Side Tab) */
        .card-side-panel {
            position: absolute; right: -50px; top: 30px;
            width: 50px; display: flex; flex-direction: column; gap: 10px;
        }
        .side-tab {
            background: var(--sdv-wood-light);
            border: 3px solid var(--sdv-wood-dark);
            border-left: none;
            padding: 10px 5px;
            font-size: 20px; cursor: pointer;
            box-shadow: 3px 3px 0 rgba(0,0,0,0.3);
            border-radius: 0 8px 8px 0;
            color: #fff; text-shadow: 1px 1px 0 #000;
            transition: transform 0.2s;
            position: relative;
        }
        .side-tab:hover { transform: translateX(5px); background: var(--sdv-green); }

        /* åˆ†ç»„é€‰æ‹©å™¨å¼¹çª— */
        .group-selector-wrapper {
            position: absolute; right: -180px; top: 30px;
            width: 160px; background: var(--sdv-cream);
            border: 3px solid var(--sdv-text-brown);
            padding: 10px; border-radius: 4px;
            box-shadow: 5px 5px 0 rgba(0,0,0,0.5);
            display: none; /* é»˜è®¤éšè— */
            flex-direction: column; gap: 5px;
            z-index: 55; font-family: 'SimSun';
        }
        .group-selector-wrapper.show { display: flex; animation: popIn 0.2s; }
        .group-select-label { font-size: 12px; color: #3e2723; font-weight: bold; margin-bottom: 5px; text-align: left;}
        .pixel-select {
            width: 100%; padding: 5px; font-family: 'SimSun', monospace;
            border: 2px solid #3e2723; background: #fff; outline: none;
        }
        @keyframes popIn { from { transform: scale(0); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        .card-glass-icon { 
            font-size: 60px; margin: 15px 0 10px 0; display: inline-block; 
            filter: drop-shadow(3px 3px 0 rgba(0,0,0,0.2));
            animation: floatIcon 3s ease-in-out infinite;
        }
        @keyframes floatIcon { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }

        .card-title { 
            font-family: 'Press Start 2P', 'SimSun', monospace; 
            font-size: 18px; margin-bottom: 5px; 
            color: var(--sdv-text-brown); line-height: 1.4;
        }
        .card-subtitle { 
            font-size: 16px; color: #888; margin-bottom: 20px; 
            text-transform: uppercase; letter-spacing: 1px; border-bottom: 2px solid #d4bba3; padding-bottom: 10px;
        }
        
        .card-section { text-align: left; margin-bottom: 15px; padding: 5px; position: relative; z-index: 1;}
        .card-label { font-size: 14px; color: #a05050; font-weight: bold; margin-bottom: 2px; display: block; font-family: 'Press Start 2P', 'SimSun'; font-size: 10px;}
        .card-text { font-size: 20px; color: #4a2810; line-height: 1.2; outline: none; background: transparent; border: none; font-weight: bold;}
        
        .tag-pill { 
            display: inline-block; padding: 2px 6px; 
            background: var(--sdv-blue-ui); color: #fff;
            font-size: 14px; margin-right: 5px; margin-top: 5px; border-radius: 4px;
            box-shadow: 1px 1px 0 #000;
        }

        .card-actions {
            position: absolute; top: 10px; left: 15px;
            display: flex; gap: 10px; z-index: 2;
        }
        .action-icon-btn {
            font-size: 20px; cursor: pointer; color: #888; transition: 0.2s;
            background: transparent; border: none; padding: 0; outline: none;
        }
        .action-icon-btn:hover { color: var(--sdv-wood-light); transform: scale(1.2); }
        .action-icon-btn.active { color: #ffd700; text-shadow: 1px 1px 0 #b8860b; }
        .action-icon-btn.saved { color: var(--sdv-green); }

        /* é…¿é€ åŠ¨ç”» */
        #mixing-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 60;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: opacity 0.2s;
        }
        #mixing-overlay.active { opacity: 1; pointer-events: auto; }

        .mixing-bowl {
            width: 80px; height: 100px; 
            background: #6d4c41; 
            border: 4px solid #3e2723;
            border-radius: 10px;
            box-shadow: inset 5px 0 0 rgba(0,0,0,0.2);
            margin-bottom: 40px; position: relative;
            animation: bounceKeg 0.5s infinite alternate;
        }
        .mixing-bowl::before {
            content:''; position: absolute; top: -10px; left: -10px; right: -10px; height: 20px;
            background: #8d6e63; border: 4px solid #3e2723; border-radius: 4px;
        }
        .mixing-bowl::after {
            content: 'ğŸ’¤'; position: absolute; top: -40px; right: -20px; font-size: 24px;
            animation: floatBubble 1s infinite;
        }

        @keyframes bounceKeg {
            0% { transform: scale(1, 1) translateY(0); }
            100% { transform: scale(1.1, 0.9) translateY(5px); }
        }
        @keyframes floatBubble {
            0% { opacity: 0; transform: translateY(0); }
            50% { opacity: 1; }
            100% { opacity: 0; transform: translateY(-20px); }
        }

        .mix-progress-container { 
            width: 200px; height: 20px; border: 4px solid #3e2723; 
            background: #222; border-radius: 10px; overflow: hidden; margin-bottom: 20px;
        }
        .mix-progress-bar {
            height: 100%; width: 0%; background: linear-gradient(to right, #76c7c0, #4db6ac);
            transition: width 0.1s steps(4);
        }
        .mix-text { 
            color: #fff; font-size: 20px; font-family: 'Press Start 2P'; 
            letter-spacing: 2px; min-height: 20px; text-align: center;
            text-shadow: 2px 2px 0 #000;
        }

        #big-reveal-icon {
            font-size: 80px; position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%) scale(0); opacity: 0;
            filter: drop-shadow(0 0 10px #fff);
            transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        #big-reveal-icon.popping { opacity: 1; transform: translate(-50%, -50%) scale(1.5); }

        /* ä¾§è¾¹æ  */
        #control-panel-wrapper { position: relative; flex: 0 0 360px; width: 360px; height: 100%; z-index: 10; transition: all 0.3s ease-in-out; margin-right: 0; }
        #control-panel-wrapper.collapsed { margin-right: -360px; }
        #control-panel-body { width: 100%; height: 100%; background-color: var(--bg-panel); box-shadow: -5px 0 20px rgba(0, 0, 0, 0.1); padding: 30px; box-sizing: border-box; display: flex; flex-direction: column; overflow: hidden; transition: background-color 0.5s ease; }
        #control-panel-wrapper.collapsed #control-panel-body { box-shadow: none; }
        #toggle-sidebar-btn { position: absolute; left: -24px; top: 50%; transform: translateY(-50%); width: 24px; height: 60px; background-color: var(--bg-panel); border: 1px solid var(--border-color); border-right: none; border-radius: 8px 0 0 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--primary-color); box-shadow: -2px 0 5px rgba(0,0,0,0.05); z-index: 11; transition: background-color 0.5s ease, color 0.5s ease; }
        #toggle-sidebar-btn:hover { filter: brightness(0.95); }
        h2 { color: var(--text-dark); margin-top: 0; border-bottom: 2px solid var(--border-color); padding-bottom: 15px; font-size: 22px; text-align: center; letter-spacing: 2px; font-weight: 600; }
        .input-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; color: var(--text-dark); font-weight: bold; font-size: 14px; }
        select, input { width: 100%; padding: 12px 15px; border: 2px solid var(--border-color); border-radius: 12px; box-sizing: border-box; outline: none; transition: 0.3s; background: rgba(255,255,255,0.5); color: var(--text-dark); font-size: 14px; }
        select:focus, input:focus { border-color: var(--primary-color); background: #fff; box-shadow: 0 0 8px rgba(0,0,0,0.1); }
        button#add-btn { width: 100%; padding: 14px; background: var(--primary-color); color: white; border: none; border-radius: 12px; cursor: pointer; font-size: 16px; font-weight: bold; box-shadow: 0 4px 12px rgba(0,0,0,0.2); transition: transform 0.2s, background 0.3s; }
        button#add-btn:hover { background-color: var(--primary-dark); transform: translateY(-2px); }
        .mode-switch-container { display: flex; align-items: center; justify-content: space-between; background: rgba(0,0,0,0.03); padding: 10px 15px; border-radius: 12px; margin-bottom: 10px; border: 1px solid var(--border-color); }
        .switch-label { font-weight: bold; color: var(--text-dark); display: flex; align-items: center; gap: 8px; font-size: 13px;}
        .toggle-checkbox { display: none; }
        .toggle-slot { position: relative; height: 20px; width: 40px; border: 2px solid var(--border-color); border-radius: 20px; background-color: white; transition: background-color 250ms; cursor: pointer; }
        .toggle-button { transform: translate(2px, 2px); position: absolute; height: 16px; width: 16px; border-radius: 50%; background-color: #ccc; box-shadow: 0 1px 3px rgba(0,0,0,0.3); transition: background-color 250ms, box-shadow 250ms, transform 250ms cubic-bezier(.2, .4, .0, 1); }
        #mystery-toggle:checked ~ .toggle-slot { background-color: #7e57c2; border-color: #7e57c2; }
        #mystery-toggle:checked ~ .toggle-slot .toggle-button { background-color: #fff; transform: translate(22px, 2px); }
        #bar-toggle:checked ~ .toggle-slot { background-color: #ff9900; border-color: #ff9900; }
        #bar-toggle:checked ~ .toggle-slot .toggle-button { background-color: #fff; transform: translate(22px, 2px); }
        #book-list-display { margin-top: 15px; flex: 1; overflow-y: auto; padding-right: 5px;}
        #book-list-display::-webkit-scrollbar { width: 5px; }
        #book-list-display::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 10px; }
        .country-item { margin-bottom: 15px; background: rgba(255,255,255,0.8); border: 1px solid var(--border-color); border-radius: 12px; padding: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); transition: 0.2s; border-left: 5px solid var(--primary-color); }
        .country-head { font-weight: bold; color: var(--text-dark); display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 16px; }
        .book-row { display: flex; gap: 10px; padding: 10px 0; border-top: 1px dashed var(--border-color); font-size: 14px; color: var(--text-light); transition: background 0.2s; align-items: center;}
        .book-cover { width: 40px; height: 55px; background: #eee; border-radius: 4px; object-fit: cover; box-shadow: 0 2px 4px rgba(0,0,0,0.1); flex-shrink: 0; }
        .book-info { flex: 1; display: flex; flex-direction: column; justify-content: center; overflow: hidden; }
        .book-title { font-weight: bold; color: var(--text-dark); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
        .book-meta { font-size: 12px; color: #999; margin-top: 3px; display: flex; align-items: center; gap: 5px;}
        .mystery-tag { background-color: var(--tag-bg); color: var(--tag-text); padding: 1px 5px; border-radius: 4px; font-size: 10px; font-weight: bold; border: 1px solid var(--border-color); }
        .btn-group { display: flex; gap: 5px; align-items: center; }
        .action-btn { cursor: pointer; padding: 4px 8px; border-radius: 6px; font-size: 12px; text-align: center; border: 1px solid transparent; background: rgba(255,255,255,0.6); }
        .edit-btn { color: var(--primary-color); border-color: var(--primary-color); }
        .delete-btn { color: var(--accent-warm); border-color: var(--accent-warm); }
        .bar-btn { color: #ff9900; border-color: #ff9900; font-size: 14px; }
        .action-btn:hover { filter: brightness(0.95); transform: translateY(-1px); }
        @media (max-width: 768px) { body { flex-direction: column; overflow: auto; } #left-stage { height: 50vh; flex: none; } #control-panel-wrapper { height: auto; flex: none; width: 100%; } }
    </style>
</head>
<body>
    <div id="loading-mask">
        <div class="spinner"></div>
        <div id="loading-text">ç³»ç»Ÿåˆå§‹åŒ–ä¸­...</div>
    </div>

    <div id="left-stage">
        <div id="map-container"><div id="main"></div></div>
        
        <div id="bar-interface">
            <div id="mixing-overlay">
                <div class="mixing-bowl"></div>
                <div class="mix-progress-container"><div class="mix-progress-bar" id="mix-bar"></div></div>
                <div class="mix-text" id="mix-text">BREWING...</div>
                <div id="big-reveal-icon"></div>
            </div>

            <div class="bar-nav">
                <div class="bar-nav-item active" onclick="switchBarTab('random')">ğŸ æ¯æ—¥ç‰¹è°ƒ</div>
                <div class="bar-nav-item" onclick="switchBarTab('filter')">ğŸº å§å°</div>
                <div class="bar-nav-item" onclick="switchBarTab('fav')">ğŸ· é…’çª–</div>
            </div>

            <div class="bar-content">
                <div id="view-random" class="bar-view active">
                    <div class="neon-sign">STARDROP SALOON<br><span style="font-size:16px;">Reading Edition</span></div>
                    <div style="color:#eee; margin-bottom:30px; font-size: 20px; font-family:'VT323';">â€œç”Ÿæ´»å°±åƒå¯ä¹é¥¼ï¼Œçƒ­è…¾è…¾çš„æ‰å¥½åƒã€‚â€</div>
                    <button class="random-btn" onclick="serveRandomDrink()">ä¸ä¹‹å…±é¥®</button>
                </div>

                <div id="view-filter" class="bar-view">
                    <div class="filter-group">
                        <span class="filter-title">åŸºé…’é€‰æ‹© (Base)</span>
                        <div class="filter-options" id="opt-base">
                            <div class="filter-opt selected" onclick="selectOpt(this, 'base', 'any')">ä»»æ„</div>
                            <div class="filter-opt" onclick="selectOpt(this, 'base', 'Gin')">é‡‘é…’</div>
                            <div class="filter-opt" onclick="selectOpt(this, 'base', 'Whiskey')">å¨å£«å¿Œ</div>
                            <div class="filter-opt" onclick="selectOpt(this, 'base', 'Rum')">æœ—å§†</div>
                            <div class="filter-opt" onclick="selectOpt(this, 'base', 'Vodka')">ä¼ç‰¹åŠ </div>
                            <div class="filter-opt" onclick="selectOpt(this, 'base', 'Tequila')">é¾™èˆŒå…°</div>
                        </div>
                    </div>

                    <div class="filter-group">
                        <span class="filter-title">é£å‘³åå¥½</span>
                        <div class="filter-options" id="opt-taste">
                            <div class="filter-opt selected" onclick="selectOpt(this, 'taste', 'any')">æ— é™åˆ¶</div>
                            <div class="filter-opt" onclick="selectOpt(this, 'taste', 'sour')">é…¸ (Sour)</div>
                            <div class="filter-opt" onclick="selectOpt(this, 'taste', 'sweet')">ç”œ (Sweet)</div>
                            <div class="filter-opt" onclick="selectOpt(this, 'taste', 'bitter')">è‹¦ (Bitter)</div>
                        </div>
                    </div>
                    <div class="filter-group">
                        <span class="filter-title">çƒˆåº¦ç­‰çº§</span>
                        <div class="filter-options" id="opt-strength">
                            <div class="filter-opt selected" onclick="selectOpt(this, 'strength', 'any')">ä»»æ„</div>
                            <div class="filter-opt" onclick="selectOpt(this, 'strength', 'light')">è½»å¾® (Low)</div>
                            <div class="filter-opt" onclick="selectOpt(this, 'strength', 'medium')">é€‚ä¸­ (Med)</div>
                            <div class="filter-opt" onclick="selectOpt(this, 'strength', 'strong')">å¼ºçƒˆ (High)</div>
                        </div>
                    </div>
                    <button class="produce-btn" onclick="serveFilteredDrink()">>>> å¼€å§‹é…¿é€  <<<</button>
                </div>

                <div id="view-fav" class="bar-view">
                    <div class="fav-groups-container" id="fav-groups-display"></div>
                    <div class="add-group-btn" onclick="addNewGroup()">+ æ–°å»ºè´§æ¶ +</div>
                </div>
            </div>
            
            <div class="drink-card-overlay" id="drink-overlay">
                <div class="drink-card" id="capture-target">
                    <div class="card-actions">
                        <button class="action-icon-btn" id="btn-fav" onclick="toggleFavorite()" title="æ”¶è—">â˜…</button>
                        <button class="action-icon-btn" id="btn-save" onclick="saveCurrentCard()" title="ä¿å­˜ä¿®æ”¹">ğŸ’¾</button>
                        <button class="action-icon-btn" id="btn-download" onclick="downloadCard()" title="ä¸‹è½½å¡ç‰‡">ğŸ“¥</button>
                    </div>

                    <div class="card-close" onclick="closeDrinkCard()">X</div>
                    
                    <div class="card-glass-icon" id="card-icon">ğŸ¸</div>
                    <div class="card-title" id="card-title">ä¹¦å</div>
                    <div class="card-subtitle" id="card-base">Base Spirit</div>
                    
                    <div class="card-section">
                        <span class="card-label">FLAVOR PROFILE</span>
                        <div class="card-text" id="card-intro" contenteditable="true" spellcheck="false">...</div>
                        <div style="margin-top:5px;" id="card-tags"></div>
                    </div>
                    <div class="card-section">
                        <span class="card-label">INGREDIENTS</span>
                        <div class="card-text" id="card-ingredients" contenteditable="true" spellcheck="false">...</div>
                    </div>
                    <div class="card-section">
                        <span class="card-label">METHOD</span>
                        <div class="card-text" id="card-method" contenteditable="true" spellcheck="false">...</div>
                    </div>
                    
                    <div style="font-size:14px; color:#8d6e63; margin-top:15px; border-top: 2px dashed #d4bba3; padding-top:5px; font-family:'Press Start 2P'; font-size:10px;">GLASS TYPE: <span id="card-glass">...</span></div>

                    <div class="card-side-panel" id="card-side-panel">
                        <div class="side-tab" onclick="toggleGroupSelector()" title="æ›´æ”¹åˆ†ç»„">ğŸ·ï¸</div>
                    </div>
                    
                    <div class="group-selector-wrapper" id="group-selector-popup">
                        <div class="group-select-label">ç§»åŠ¨è‡³åˆ†ç»„:</div>
                        <select class="pixel-select" id="card-group-select" onchange="changeCardGroup(this.value)">
                            </select>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="control-panel-wrapper">
        <div id="toggle-sidebar-btn" onclick="toggleSidebar()">â–¶</div>
        <div id="control-panel-body">
            <h2>ğŸŒ¿ é˜…è¯»è®°å½•</h2>
            <div class="mode-switch-container">
                <div class="switch-label"><span id="mode-icon">ğŸ•µï¸</span> <span>ä»…æ˜¾ç¤ºæ‚¬ç–‘</span></div>
                <label><input class="toggle-checkbox" type="checkbox" id="mystery-toggle" onchange="toggleMysteryMode()"><div class="toggle-slot"><div class="toggle-button"></div></div></label>
            </div>
            <div class="mode-switch-container">
                <div class="switch-label"><span id="mode-icon">ğŸ»</span> <span>æ˜Ÿä¹‹æœå®æ¨¡å¼</span></div>
                <label><input class="toggle-checkbox" type="checkbox" id="bar-toggle" onchange="toggleBarMode()"><div class="toggle-slot"><div class="toggle-button"></div></div></label>
            </div>
            <div class="input-group">
                <label>ğŸ“ åœ°åŒºç­›é€‰ / å½•å…¥</label>
                <select id="country-select" onchange="filterList()"></select>
            </div>
            <div class="input-group">
                <label>ğŸ“– ä¹¦å (æ™ºèƒ½åˆ†ç±»)</label>
                <input type="text" id="book-name" placeholder="è¾“å…¥ä¹¦å...">
            </div>
            <button id="add-btn" onclick="addBook()">âœ¨ æ™ºèƒ½è®°å½•</button>
            <div id="book-list-display"></div>
        </div>
    </div>

    <script>
        // ================= æ ¸å¿ƒé…ç½®ä¸æ•°æ® =================
        const BIN_ID = '6940072543b1c97be9efcbb6'; 
        const API_KEY = '$2a$10$NK41BeroKJUHwITABG5hSOUM2STrIJgPrdkrbHXwIWmI4pHlPR2da'; 

        // ğŸ¸ é¸¡å°¾é…’æ•°æ®åº“
        const COCKTAIL_DB = [
            { id: 'negroni', base: 'Gin', profile: 'bitter', strength: 'strong', name: 'Negroni', glass: 'Rocks', intro: 'è‹¦ä¹å‚åŠçš„å¹³è¡¡ï¼Œå¦‚åŒå‘½è¿çš„ç©ç¬‘ã€‚', materials: '30ml é‡‘é…’, 30ml é‡‘å·´åˆ©, 30ml ç”œå‘³ç¾æ€', method: 'åŠ å†°æ…æ‹Œï¼Œé¥°ä»¥æ©™çš®ã€‚' },
            { id: 'old_fashioned', base: 'Whiskey', profile: 'bitter', strength: 'strong', name: 'Old Fashioned', glass: 'Rocks', intro: 'ç»å…¸æ°¸ä¸è¿‡æ—¶ï¼Œæ²‰ç¨³è€Œæ·±é‚ƒã€‚', materials: '45ml æ³¢æœ¬å¨å£«å¿Œ, 1å—æ–¹ç³–, 2æ»´è‹¦ç²¾', method: 'æ–¹ç³–æµ¸è‹¦ç²¾æ£ç¢ï¼ŒåŠ å†°åŠ é…’æ…æ‹Œã€‚' },
            { id: 'martini', base: 'Gin', profile: 'dry', strength: 'strong', name: 'Dry Martini', glass: 'Martini', intro: 'æç®€ä¸»ä¹‰çš„å†·å³»ï¼Œé”‹åˆ©å¦‚åˆ€ã€‚', materials: '60ml é‡‘é…’, 10ml å¹²å‘³ç¾æ€', method: 'åŠ å†°æ…æ‹Œè‡³æå†·ï¼Œæ»¤å…¥å†°å†»é…’æ¯ã€‚' },
            { id: 'margarita', base: 'Tequila', profile: 'sour', strength: 'medium', name: 'Margarita', glass: 'Coupe', intro: 'å’¸ä¸é…¸çš„äº¤ç»‡ï¼Œçƒ­çƒˆçš„æƒ…æ„Ÿçˆ†å‘ã€‚', materials: '45ml é¾™èˆŒå…°, 20ml å›åº¦, 20ml é’æŸ æ±, ç›', method: 'ç›è¾¹ï¼ŒåŠ å†°æ‘‡å’Œã€‚' },
            { id: 'whiskey_sour', base: 'Whiskey', profile: 'sour', strength: 'medium', name: 'Whiskey Sour', glass: 'Rocks', intro: 'æŸ”æ»‘çš„é…¸ç”œï¼ŒæŠšå¹³å†…å¿ƒçš„è¤¶çš±ã€‚', materials: '45ml å¨å£«å¿Œ, 20ml æŸ æª¬æ±, 15ml ç³–æµ†, è›‹ç™½', method: 'å¹²æ‘‡ååŠ å†°æ‘‡å’Œã€‚' },
            { id: 'daiquiri', base: 'Rum', profile: 'sour', strength: 'medium', name: 'Daiquiri', glass: 'Coupe', intro: 'æµ·æ˜å¨çš„æœ€çˆ±ï¼Œçº¯ç²¹çš„çƒ­å¸¦é£æš´ã€‚', materials: '60ml ç™½æœ—å§†, 25ml é’æŸ æ±, 15ml ç³–æµ†', method: 'åŠ å†°æ‘‡å’Œã€‚' },
            { id: 'mojito', base: 'Rum', profile: 'sweet', strength: 'light', name: 'Mojito', glass: 'Highball', intro: 'è–„è·çš„æ¸…å‡‰ï¼Œå¤æ—¥åˆåçš„ç™½æ—¥æ¢¦ã€‚', materials: '50ml ç™½æœ—å§†, è–„è·å¶, é’æŸ , ç³–, è‹æ‰“æ°´', method: 'æ£ç¢è–„è·é’æŸ ï¼ŒåŠ ç¢å†°æ…æ‹Œã€‚' },
            { id: 'aperol_spritz', base: 'Prosecco', profile: 'bitter', strength: 'light', name: 'Aperol Spritz', glass: 'Wine', intro: 'å¤•é˜³èˆ¬çš„æ©™è‰²ï¼Œè½»æ¾æ„‰æ‚¦çš„å¼€ç¯‡ã€‚', materials: '90ml èµ·æ³¡é…’, 60ml é˜¿ä½©ç½—, è‹æ‰“æ°´', method: 'æ»¡å†°ç›´è°ƒã€‚' },
            { id: 'godfather', base: 'Whiskey', profile: 'sweet', strength: 'strong', name: 'Godfather', glass: 'Rocks', intro: 'æä»çš„é¦™ç”œæ©ç›–äº†å¨å£«å¿Œçš„çƒˆã€‚', materials: '45ml è‹æ ¼å…°å¨å£«å¿Œ, 15ml æä»åˆ©å£é…’', method: 'åŠ å†°æ…æ‹Œã€‚' },
            { id: 'manhattan', base: 'Whiskey', profile: 'bitter', strength: 'strong', name: 'Manhattan', glass: 'Coupe', intro: 'åŸå¸‚çš„å¤œè‰²ï¼Œçº¢æ¨±æ¡ƒèˆ¬çš„è¯±æƒ‘ã€‚', materials: '50ml é»‘éº¦å¨å£«å¿Œ, 20ml ç”œå‘³ç¾æ€, è‹¦ç²¾', method: 'åŠ å†°æ…æ‹Œã€‚' },
            { id: 'cosmopolitan', base: 'Vodka', profile: 'sweet', strength: 'medium', name: 'Cosmopolitan', glass: 'Martini', intro: 'ç²‰çº¢è‰²çš„éƒ½ä¼šä¼ è¯´ï¼Œæ—¶å°šè€Œè¿·ç¦»ã€‚', materials: '45ml ä¼ç‰¹åŠ , 15ml å›åº¦, è”“è¶Šè“æ±, é’æŸ ', method: 'åŠ å†°æ‘‡å’Œã€‚' },
            { id: 'gin_tonic', base: 'Gin', profile: 'bitter', strength: 'medium', name: 'Gin & Tonic', glass: 'Highball', intro: 'å¥å®çš„è‹¦å‘³ï¼Œæ²»æ„ˆçµé­‚çš„è‰¯è¯ã€‚', materials: '45ml é‡‘é…’, é€šå®æ°´, é’æŸ è§’', method: 'ç›´è°ƒã€‚' },
            { id: 'long_island', base: 'Mixed', profile: 'sweet', strength: 'strong', name: 'Long Island Iced Tea', glass: 'Highball', intro: 'çœ‹ä¼¼æ— å®³çš„çº¢èŒ¶ï¼Œå®åˆ™æ··ä¹±çš„æ·±æ¸Šã€‚', materials: 'äº”å¤§åŸºé…’å„15ml, æŸ æª¬æ±, å¯ä¹', method: 'åŠ å†°æ‘‡å’Œåæ³¨æ»¡å¯ä¹ã€‚' },
            { id: 'bloody_mary', base: 'Vodka', profile: 'savory', strength: 'medium', name: 'Bloody Mary', glass: 'Highball', intro: 'ç•ªèŒ„ä¸é¦™æ–™çš„ç‹‚æ¬¢ï¼Œå¤æ‚çš„æ•‘èµã€‚', materials: '45ml ä¼ç‰¹åŠ , ç•ªèŒ„æ±, æŸ æª¬, è¾£é…±æ²¹, ç›èƒ¡æ¤’', method: 'æ»šæ³•è°ƒåˆ¶ã€‚' },
            { id: 'white_russian', base: 'Vodka', profile: 'sweet', strength: 'medium', name: 'White Russian', glass: 'Rocks', intro: 'ä¸æ»‘çš„å¥¶æ²¹ï¼Œæ…µæ‡’çš„å“²å­¦ã€‚', materials: '45ml ä¼ç‰¹åŠ , 20ml å’–å•¡åˆ©å£é…’, é²œå¥¶æ²¹', method: 'ç›´è°ƒï¼Œå¥¶æ²¹æ¼‚æµ®ã€‚' },
            { id: 'pina_colada', base: 'Rum', profile: 'sweet', strength: 'medium', name: 'PiÃ±a Colada', glass: 'Hurricane', intro: 'è èä¸æ¤°å¥¶ï¼Œé€ƒç¦»ç°å®çš„å€Ÿå£ã€‚', materials: '45ml æœ—å§†, æ¤°æµ†, è èæ±', method: 'åŠ å†°æ‘‡å’Œæˆ–æ…æ‹Œã€‚' }
        ];

        var myChart = echarts.init(document.getElementById('main'));
        var myBookData = {}; 
        var geoJsonData = null;
        var allCountryList = []; 
        var isMysteryMode = false; 
        var isBarMode = false;
        var currentBarTab = 'random';
        var currentBookForDrink = null;
        
        // ğŸ†• åˆ†ç»„æ•°æ®ç»“æ„: { "é»˜è®¤æ”¶è—": ["BookTitle1", "BookTitle2"], ... }
        var favoriteGroups = { "é»˜è®¤æ”¶è—": [] };
        // ç¼“å­˜å¹³é“ºçš„åˆ—è¡¨ä»¥ä¾¿å¿«é€ŸæŸ¥è¯¢æ˜¯å¦æ”¶è— (å…¼å®¹æ—§é€»è¾‘)
        var favoriteDrinks = []; 

        var filterState = { taste: 'any', strength: 'any', base: 'any' };
        var nameMap = { 'Afghanistan': 'é˜¿å¯Œæ±—', 'Albania': 'é˜¿å°”å·´å°¼äºš', 'Algeria': 'é˜¿å°”åŠåˆ©äºš', 'Andorra': 'å®‰é“å°”', 'Angola': 'å®‰å“¥æ‹‰', 'Antarctica': 'å—ææ´²', 'Antigua and Barb.': 'å®‰æç“œå’Œå·´å¸ƒè¾¾', 'Argentina': 'é˜¿æ ¹å»·', 'Armenia': 'äºšç¾å°¼äºš', 'Australia': 'æ¾³å¤§åˆ©äºš', 'Austria': 'å¥¥åœ°åˆ©', 'Azerbaijan': 'é˜¿å¡æ‹œç–†', 'Bahamas': 'å·´å“ˆé©¬', 'Bahrain': 'å·´æ—', 'Bangladesh': 'å­ŸåŠ æ‹‰å›½', 'Barbados': 'å·´å·´å¤šæ–¯', 'Belarus': 'ç™½ä¿„ç½—æ–¯', 'Belgium': 'æ¯”åˆ©æ—¶', 'Belize': 'ä¼¯åˆ©å…¹', 'Benin': 'è´å®', 'Bermuda': 'ç™¾æ…•å¤§', 'Bhutan': 'ä¸ä¸¹', 'Bolivia': 'ç»åˆ©ç»´äºš', 'Bosnia and Herz.': 'æ³¢é»‘', 'Botswana': 'åšèŒ¨ç“¦çº³', 'Brazil': 'å·´è¥¿', 'Brunei': 'æ–‡è±', 'Bulgaria': 'ä¿åŠ åˆ©äºš', 'Burkina Faso': 'å¸ƒåŸºçº³æ³•ç´¢', 'Burundi': 'å¸ƒéš†è¿ª', 'Cambodia': 'æŸ¬åŸ”å¯¨', 'Cameroon': 'å–€éº¦éš†', 'Canada': 'åŠ æ‹¿å¤§', 'Cape Verde': 'ä½›å¾—è§’', 'Central African Rep.': 'ä¸­éå…±å’Œå›½', 'Chad': 'ä¹å¾—', 'Chile': 'æ™ºåˆ©', 'China': 'ä¸­å›½', 'Colombia': 'å“¥ä¼¦æ¯”äºš', 'Comoros': 'ç§‘æ‘©ç½—', 'Congo': 'åˆšæœå…±å’Œå›½', 'Costa Rica': 'å“¥æ–¯è¾¾é»åŠ ', 'Croatia': 'å…‹ç½—åœ°äºš', 'Cuba': 'å¤å·´', 'Cyprus': 'å¡æµ¦è·¯æ–¯', 'Czech Rep.': 'æ·å…‹å…±å’Œå›½', 'CÃ´te d\'Ivoire': 'ç§‘ç‰¹è¿ªç“¦', 'Dem. Rep. Congo': 'åˆšæœæ°‘ä¸»å…±å’Œå›½', 'Dem. Rep. Korea': 'æœé²œ', 'Denmark': 'ä¸¹éº¦', 'Djibouti': 'å‰å¸ƒæ', 'Dominica': 'å¤šç±³å°¼å…‹', 'Dominican Rep.': 'å¤šç±³å°¼åŠ ', 'Ecuador': 'å„ç“œå¤šå°”', 'Egypt': 'åŸƒåŠ', 'El Salvador': 'è¨å°”ç“¦å¤š', 'Eq. Guinea': 'èµ¤é“å‡ å†…äºš', 'Eritrea': 'å„ç«‹ç‰¹é‡Œäºš', 'Estonia': 'çˆ±æ²™å°¼äºš', 'Ethiopia': 'åŸƒå¡ä¿„æ¯”äºš', 'Falkland Is.': 'ç¦å…‹å…°ç¾¤å²›', 'Fiji': 'æ–æµ', 'Finland': 'èŠ¬å…°', 'France': 'æ³•å›½', 'Fr. S. Antarctic Lands': 'æ³•å±å—åŠçƒå’Œå—æé¢†åœ°', 'Gabon': 'åŠ è“¬', 'Gambia': 'å†ˆæ¯”äºš', 'Georgia': 'æ ¼é²å‰äºš', 'Germany': 'å¾·å›½', 'Ghana': 'åŠ çº³', 'Greece': 'å¸Œè…Š', 'Greenland': 'æ ¼é™µå…°', 'Grenada': 'æ ¼æ—çº³è¾¾', 'Guatemala': 'å±åœ°é©¬æ‹‰', 'Guinea': 'å‡ å†…äºš', 'Guinea-Bissau': 'å‡ å†…äºšæ¯”ç»', 'Guyana': 'åœ­äºšé‚£', 'Haiti': 'æµ·åœ°', 'Honduras': 'æ´ªéƒ½æ‹‰æ–¯', 'Hungary': 'åŒˆç‰™åˆ©', 'Iceland': 'å†°å²›', 'India': 'å°åº¦', 'Indonesia': 'å°åº¦å°¼è¥¿äºš', 'Iran': 'ä¼Šæœ—', 'Iraq': 'ä¼Šæ‹‰å…‹', 'Ireland': 'çˆ±å°”å…°', 'Israel': 'ä»¥è‰²åˆ—', 'Italy': 'æ„å¤§åˆ©', 'Ivory Coast': 'ç§‘ç‰¹è¿ªç“¦', 'Jamaica': 'ç‰™ä¹°åŠ ', 'Japan': 'æ—¥æœ¬', 'Jordan': 'çº¦æ—¦', 'Kazakhstan': 'å“ˆè¨å…‹æ–¯å¦', 'Kenya': 'è‚¯å°¼äºš', 'Korea': 'éŸ©å›½', 'Kosovo': 'ç§‘ç´¢æ²ƒ', 'Kuwait': 'ç§‘å¨ç‰¹', 'Kyrgyzstan': 'å‰å°”å‰æ–¯æ–¯å¦', 'Lao PDR': 'è€æŒ', 'Latvia': 'æ‹‰è„±ç»´äºš', 'Lebanon': 'é»å·´å«©', 'Lesotho': 'è±ç´¢æ‰˜', 'Liberia': 'åˆ©æ¯”é‡Œäºš', 'Libya': 'åˆ©æ¯”äºš', 'Liechtenstein': 'åˆ—æ”¯æ•¦å£«ç™»', 'Lithuania': 'ç«‹é™¶å®›', 'Luxembourg': 'å¢æ£®å ¡', 'Madagascar': 'é©¬è¾¾åŠ æ–¯åŠ ', 'Malawi': 'é©¬æ‹‰ç»´', 'Malaysia': 'é©¬æ¥è¥¿äºš', 'Mali': 'é©¬é‡Œ', 'Malta': 'é©¬è€³ä»–', 'Mauritania': 'æ¯›é‡Œå¡”å°¼äºš', 'Mauritius': 'æ¯›é‡Œæ±‚æ–¯', 'Mexico': 'å¢¨è¥¿å“¥', 'Moldova': 'æ‘©å°”å¤šç“¦', 'Monaco': 'æ‘©çº³å“¥', 'Mongolia': 'è’™å¤', 'Montenegro': 'é»‘å±±', 'Morocco': 'æ‘©æ´›å“¥', 'Mozambique': 'è«æ¡‘æ¯”å…‹', 'Myanmar': 'ç¼…ç”¸', 'Namibia': 'çº³ç±³æ¯”äºš', 'Nepal': 'å°¼æ³Šå°”', 'Netherlands': 'è·å…°', 'New Zealand': 'æ–°è¥¿å…°', 'Nicaragua': 'å°¼åŠ æ‹‰ç“œ', 'Niger': 'å°¼æ—¥å°”', 'Nigeria': 'å°¼æ—¥åˆ©äºš', 'North Korea': 'æœé²œ', 'North Macedonia': 'åŒ—é©¬å…¶é¡¿', 'Norway': 'æŒªå¨', 'Oman': 'é˜¿æ›¼', 'Pakistan': 'å·´åŸºæ–¯å¦', 'Palestine': 'å·´å‹’æ–¯å¦', 'Panama': 'å·´æ‹¿é©¬', 'Papua New Guinea': 'å·´å¸ƒäºšæ–°å‡ å†…äºš', 'Paraguay': 'å·´æ‹‰åœ­', 'Peru': 'ç§˜é²', 'Philippines': 'è²å¾‹å®¾', 'Poland': 'æ³¢å…°', 'Portugal': 'è‘¡è„ç‰™', 'Puerto Rico': 'æ³¢å¤šé»å„', 'Qatar': 'å¡å¡”å°”', 'Romania': 'ç½—é©¬å°¼äºš', 'Russia': 'ä¿„ç½—æ–¯', 'Rwanda': 'å¢æ—ºè¾¾', 'S. Sudan': 'å—è‹ä¸¹', 'Samoa': 'è¨æ‘©äºš', 'Saudi Arabia': 'æ²™ç‰¹é˜¿æ‹‰ä¼¯', 'Senegal': 'å¡å†…åŠ å°”', 'Serbia': 'å¡å°”ç»´äºš', 'Seychelles': 'å¡èˆŒå°”', 'Sierra Leone': 'å¡æ‹‰åˆ©æ˜‚', 'Singapore': 'æ–°åŠ å¡', 'Slovakia': 'æ–¯æ´›ä¼å…‹', 'Slovenia': 'æ–¯æ´›æ–‡å°¼äºš', 'Solomon Is.': 'æ‰€ç½—é—¨ç¾¤å²›', 'Somalia': 'ç´¢é©¬é‡Œ', 'South Africa': 'å—é', 'South Korea': 'éŸ©å›½', 'South Sudan': 'å—è‹ä¸¹', 'Spain': 'è¥¿ç­ç‰™', 'Sri Lanka': 'æ–¯é‡Œå…°å¡', 'Sudan': 'è‹ä¸¹', 'Suriname': 'è‹é‡Œå—', 'Swaziland': 'æ–¯å¨å£«å…°', 'Sweden': 'ç‘å…¸', 'Switzerland': 'ç‘å£«', 'Syria': 'å™åˆ©äºš', 'Taiwan': 'ä¸­å›½', 'Tajikistan': 'å¡”å‰å…‹æ–¯å¦', 'Tanzania': 'å¦æ¡‘å°¼äºš', 'Thailand': 'æ³°å›½', 'Timor-Leste': 'ä¸œå¸æ±¶', 'Togo': 'å¤šå“¥', 'Tonga': 'æ±¤åŠ ', 'Trinidad and Tobago': 'ç‰¹ç«‹å°¼è¾¾å’Œå¤šå·´å“¥', 'Tunisia': 'çªå°¼æ–¯', 'Turkey': 'åœŸè€³å…¶', 'Turkmenistan': 'åœŸåº“æ›¼æ–¯å¦', 'Uganda': 'ä¹Œå¹²è¾¾', 'Ukraine': 'ä¹Œå…‹å…°', 'United Arab Emirates': 'é˜¿è”é…‹', 'United Kingdom': 'è‹±å›½', 'United States': 'ç¾å›½', 'Uruguay': 'ä¹Œæ‹‰åœ­', 'Uzbekistan': 'ä¹Œå…¹åˆ«å…‹æ–¯å¦', 'Vanuatu': 'ç“¦åŠªé˜¿å›¾', 'Venezuela': 'å§”å†…ç‘æ‹‰', 'Vietnam': 'è¶Šå—', 'West Bank': 'è¥¿å²¸', 'W. Sahara': 'è¥¿æ’’å“ˆæ‹‰', 'Yemen': 'ä¹Ÿé—¨', 'Zambia': 'èµæ¯”äºš', 'Zimbabwe': 'æ´¥å·´å¸ƒéŸ¦' };

        // --- åˆå§‹åŒ–ä¸æ•°æ®åŠ è½½ ---
        function loadCloudData() {
            fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, { headers: { 'X-Master-Key': API_KEY } })
            .then(res => res.json())
            .then(data => {
                let record = data.record;
                myBookData = record.books || record;
                if (!myBookData) myBookData = {};

                // å…¼å®¹æ€§å¤„ç†ï¼šå¦‚æœè¯»å–åˆ°çš„æ˜¯æ—§çš„ flat array æ”¶è—ï¼Œè¿ç§»åˆ° favoriteGroups
                if (record.favoriteGroups) {
                    favoriteGroups = record.favoriteGroups;
                } else if (record.favorites && Array.isArray(record.favorites)) {
                    // æ—§æ•°æ®è¿ç§»
                    favoriteGroups = { "é»˜è®¤æ”¶è—": record.favorites };
                } else {
                    favoriteGroups = { "é»˜è®¤æ”¶è—": [] };
                }
                
                // é‡æ–°ç”Ÿæˆå¹³é“ºåˆ—è¡¨ï¼Œä¾¿äºå¿«é€ŸæŸ¥è¯¢
                rebuildFlatFavorites();

                updateUI();
                updateCountryDropdown(); 
                document.getElementById('loading-mask').style.display = 'none';
                setTimeout(() => myChart.resize(), 500);
            })
            .catch(err => { console.error(err); document.getElementById('loading-text').innerText = "åŠ è½½å¤±è´¥"; });
        }

        function rebuildFlatFavorites() {
            favoriteDrinks = [];
            for (let groupName in favoriteGroups) {
                favoriteDrinks = favoriteDrinks.concat(favoriteGroups[groupName]);
            }
        }

        function saveCloudData() {
            rebuildFlatFavorites(); // ç¡®ä¿ä¿å­˜å‰æ•°æ®ä¸€è‡´
            const payload = { 
                books: myBookData, 
                favorites: favoriteDrinks, // ä¿æŒæ—§å­—æ®µä»¥é˜²ä¸‡ä¸€
                favoriteGroups: favoriteGroups // æ–°å¢å­—æ®µ
            };
            fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
                method: 'PUT', headers: { 'Content-Type': 'application/json', 'X-Master-Key': API_KEY },
                body: JSON.stringify(payload)
            }).then(res => res.json()).then(data => { console.log('Saved'); });
        }

        // --- æ ¸å¿ƒé€»è¾‘ ---
        function getDrinkForBook(bookTitle, isMystery) {
            let seed = 0;
            for (let i = 0; i < bookTitle.length; i++) seed += bookTitle.charCodeAt(i);
            const lowerTitle = bookTitle.toLowerCase();
            let candidates = COCKTAIL_DB;

            if(isMystery || lowerTitle.includes('æ€') || lowerTitle.includes('æ­»') || lowerTitle.includes('è°œ')) {
                candidates = COCKTAIL_DB.filter(d => d.profile === 'bitter' || d.strength === 'strong');
            } else if(lowerTitle.includes('çˆ±') || lowerTitle.includes('æ¢¦') || lowerTitle.includes('å©š')) {
                candidates = COCKTAIL_DB.filter(d => d.profile === 'sweet');
            }
            if(candidates.length === 0) candidates = COCKTAIL_DB;
            return candidates[seed % candidates.length]; 
        }

        function switchBarTab(tab) {
            currentBarTab = tab;
            document.querySelectorAll('.bar-nav-item').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.bar-view').forEach(el => el.classList.remove('active'));
            const index = tab === 'random' ? 0 : tab === 'filter' ? 1 : 2;
            document.querySelectorAll('.bar-nav-item')[index].classList.add('active');
            document.getElementById('view-' + tab).classList.add('active');
            if(tab === 'fav') renderFavorites();
        }

        function selectOpt(el, type, val) {
            filterState[type] = val;
            el.parentElement.querySelectorAll('.filter-opt').forEach(d => d.classList.remove('selected'));
            el.classList.add('selected');
        }

        // --- æ‹–æ‹½ä¸åˆ†ç»„é€»è¾‘ ---
        function addNewGroup() {
            const name = prompt("è¯·è¾“å…¥æ–°è´§æ¶åç§°:", "æ–°åˆ†ç±»");
            if (name) {
                if (favoriteGroups[name]) return alert("è¯¥åˆ†ç±»å·²å­˜åœ¨ï¼");
                favoriteGroups[name] = [];
                saveCloudData();
                renderFavorites();
            }
        }

        function renameGroup(oldName) {
            const newName = prompt("é‡å‘½åè´§æ¶:", oldName);
            if (newName && newName !== oldName) {
                if (favoriteGroups[newName]) return alert("è¯¥åˆ†ç±»å·²å­˜åœ¨ï¼");
                favoriteGroups[newName] = favoriteGroups[oldName];
                delete favoriteGroups[oldName];
                saveCloudData();
                renderFavorites();
            }
        }

        function deleteGroup(groupName) {
            if (confirm(`ç¡®å®šæ‹†é™¤è´§æ¶â€œ${groupName}â€å—ï¼Ÿ\né‡Œé¢çš„é¥®å“å°†ç§»åŠ¨åˆ°â€œé»˜è®¤æ”¶è—â€ã€‚`)) {
                const items = favoriteGroups[groupName];
                if (!favoriteGroups["é»˜è®¤æ”¶è—"]) favoriteGroups["é»˜è®¤æ”¶è—"] = [];
                favoriteGroups["é»˜è®¤æ”¶è—"] = favoriteGroups["é»˜è®¤æ”¶è—"].concat(items);
                delete favoriteGroups[groupName];
                saveCloudData();
                renderFavorites();
            }
        }

        // æ‹–æ‹½äº‹ä»¶å¤„ç†
        function allowDrop(ev) { ev.preventDefault(); ev.currentTarget.classList.add('drag-over'); }
        function leaveDrop(ev) { ev.currentTarget.classList.remove('drag-over'); }
        function drag(ev) {
            ev.dataTransfer.setData("text", ev.target.dataset.bookTitle);
            ev.dataTransfer.setData("sourceGroup", ev.target.dataset.groupName);
        }
        function drop(ev, targetGroupName) {
            ev.preventDefault();
            ev.currentTarget.classList.remove('drag-over');
            const title = ev.dataTransfer.getData("text");
            const sourceGroup = ev.dataTransfer.getData("sourceGroup");
            
            if (sourceGroup === targetGroupName) return;

            // ç§»åŠ¨æ•°æ®
            const oldList = favoriteGroups[sourceGroup];
            const idx = oldList.indexOf(title);
            if (idx > -1) {
                oldList.splice(idx, 1);
                favoriteGroups[targetGroupName].push(title);
                saveCloudData();
                renderFavorites();
            }
        }

        // --- æ¸²æŸ“æ”¶è—å¤¹ (åˆ†ç»„è§†å›¾) ---
        function renderFavorites() {
            const container = document.getElementById('fav-groups-display');
            container.innerHTML = '';
            
            let allBooksMap = {};
            for(let c in myBookData) myBookData[c].forEach(b => allBooksMap[getBookObject(b).title] = getBookObject(b));

            if (Object.keys(favoriteGroups).length === 0) favoriteGroups = { "é»˜è®¤æ”¶è—": [] };

            for (let groupName in favoriteGroups) {
                const items = favoriteGroups[groupName];
                
                // ç»„å®¹å™¨
                const groupDiv = document.createElement('div');
                groupDiv.className = 'fav-group';
                groupDiv.ondrop = (ev) => drop(ev, groupName);
                groupDiv.ondragover = allowDrop;
                groupDiv.ondragleave = leaveDrop;

                // ç»„æ ‡é¢˜
                let deleteHtml = groupName !== 'é»˜è®¤æ”¶è—' ? `<span class="group-delete-btn" onclick="deleteGroup('${groupName}')">Ã— æ‹†é™¤</span>` : '';
                groupDiv.innerHTML = `<div class="group-header">
                    <span class="group-title" onclick="renameGroup('${groupName}')">${groupName} (${items.length})</span>
                    ${deleteHtml}
                </div>`;

                // ç‰©å“ç½‘æ ¼
                const gridDiv = document.createElement('div');
                gridDiv.className = 'fav-grid';
                
                items.forEach(title => {
                    const book = allBooksMap[title];
                    if(book) {
                        const drink = getDrinkForBook(title, book.isMystery);
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'fav-item';
                        itemDiv.draggable = true;
                        itemDiv.dataset.bookTitle = title;
                        itemDiv.dataset.groupName = groupName;
                        itemDiv.ondragstart = drag;
                        itemDiv.onclick = () => showDrinkCard(book);
                        itemDiv.innerHTML = `<div class="fav-icon">${getGlassIcon(drink.glass)}</div><div class="fav-name">${title}</div>`;
                        gridDiv.appendChild(itemDiv);
                    }
                });
                
                groupDiv.appendChild(gridDiv);
                container.appendChild(groupDiv);
            }
        }

        // --- ä¾§è¾¹æ åˆ†ç»„é€‰æ‹©å™¨é€»è¾‘ ---
        function toggleGroupSelector() {
            const popup = document.getElementById('group-selector-popup');
            const select = document.getElementById('card-group-select');
            
            // å¡«å……é€‰é¡¹
            select.innerHTML = '';
            let currentGroup = '';
            
            // æŸ¥æ‰¾å½“å‰æ‰€å±ç»„
            for (let g in favoriteGroups) {
                if (favoriteGroups[g].includes(currentBookForDrink.title)) {
                    currentGroup = g;
                    break;
                }
            }
            if (!currentGroup) {
                 // æœªæ”¶è—
                 select.innerHTML = '<option value="">(æœªæ”¶è—)</option>';
            }

            for (let g in favoriteGroups) {
                const opt = document.createElement('option');
                opt.value = g;
                opt.innerText = g;
                if (g === currentGroup) opt.selected = true;
                select.appendChild(opt);
            }

            popup.classList.toggle('show');
        }

        function changeCardGroup(newGroup) {
            const title = currentBookForDrink.title;
            // å…ˆä»æ—§ç»„ç§»é™¤
            for (let g in favoriteGroups) {
                const idx = favoriteGroups[g].indexOf(title);
                if (idx > -1) {
                    favoriteGroups[g].splice(idx, 1);
                }
            }
            // åŠ å…¥æ–°ç»„
            if (favoriteGroups[newGroup]) {
                favoriteGroups[newGroup].push(title);
            }
            
            saveCloudData();
            updateFavIconState(); // å¦‚æœä¹‹å‰æ²¡æ”¶è—ï¼Œç°åœ¨æ”¶è—äº†ï¼Œæ˜Ÿæ˜Ÿè¦äº®
            if(currentBarTab === 'fav') renderFavorites();
            document.getElementById('group-selector-popup').classList.remove('show');
        }

        // --- é€šç”¨ ---
        function serveRandomDrink() {
            let allBooks = [];
            for(let c in myBookData) myBookData[c].forEach(b => allBooks.push(b));
            if(allBooks.length === 0) return alert("ä¹¦æ¶æ˜¯ç©ºçš„ï¼Œå…ˆå»è®°å½•å‡ æœ¬ä¹¦å§ï¼");
            const randomBook = allBooks[Math.floor(Math.random() * allBooks.length)];
            const bookObj = getBookObject(randomBook);
            const drink = getDrinkForBook(bookObj.title, bookObj.isMystery);
            playMixingAnimation(bookObj, drink);
        }

        function serveFilteredDrink() {
            let allBooks = [];
            for(let c in myBookData) myBookData[c].forEach(b => allBooks.push(getBookObject(b)));
            let validDrinks = COCKTAIL_DB.filter(d => {
                let matchTaste = filterState.taste === 'any' || d.profile === filterState.taste;
                let matchStrength = filterState.strength === 'any' || d.strength === filterState.strength;
                let matchBase = filterState.base === 'any' || d.base.toLowerCase() === filterState.base.toLowerCase();
                return matchTaste && matchStrength && matchBase;
            });
            if(validDrinks.length === 0) return alert("é…’å•ä¸­æ²¡æœ‰ç¬¦åˆè¿™ç§åˆé’»å£å‘³çš„é…æ–¹...");
            if(allBooks.length === 0) return alert("æ²¡æœ‰ä¹¦å¯åšé…’äº†ã€‚");
            const targetDrinkBase = validDrinks[Math.floor(Math.random() * validDrinks.length)];
            const randomBook = allBooks[Math.floor(Math.random() * allBooks.length)];
            playMixingAnimation(randomBook, targetDrinkBase);
        }

        // åŠ¨ç”»
        const MIX_PHRASES = ["æ­£åœ¨æ”¾å…¥å‘é…µæ¡¶...", "æ·»åŠ å¤ä»£æ°´æœ...", "ç­‰å¾…å­£èŠ‚è½®è½¬...", "å¬å–ç¥å°¼é­”çš„ä½è¯­...", "ä»åœ°çª–å–å‡ºé™ˆé…¿...", "æ­£åœ¨æ“¦æ‹­ç»ç’ƒæ¯...", "åŠ å…¥ä¸€ç‚¹æ˜Ÿä¹‹ç²‰å°˜..."];
        function playMixingAnimation(book, drink) {
            const overlay = document.getElementById('mixing-overlay');
            const mixBar = document.getElementById('mix-bar');
            const mixText = document.getElementById('mix-text');
            const revealIcon = document.getElementById('big-reveal-icon');
            overlay.classList.add('active');
            mixBar.style.width = '0%';
            revealIcon.classList.remove('popping');
            revealIcon.innerHTML = getGlassIcon(drink.glass); 
            let progress = 0;
            const interval = setInterval(() => {
                progress += 5;
                mixBar.style.width = progress + '%';
                if(progress % 20 === 0) mixText.innerText = MIX_PHRASES[Math.floor(Math.random() * MIX_PHRASES.length)];
                if(progress >= 100) {
                    clearInterval(interval);
                    mixText.innerText = "é…¿ é€  å®Œ æˆ !";
                    revealIcon.classList.add('popping');
                    setTimeout(() => {
                        overlay.classList.remove('active');
                        showDrinkCard(book, drink); 
                    }, 600); 
                }
            }, 80); 
        }

        function getGlassIcon(glass) {
            if(glass === 'Martini') return 'ğŸ¸';
            if(glass === 'Rocks') return 'ğŸ¥ƒ';
            if(glass === 'Wine') return 'ğŸ·';
            if(glass === 'Coupe') return 'ğŸ¥‚';
            if(glass === 'Highball') return 'ğŸ¹';
            return 'ğŸº';
        }

        function toggleFavorite() {
            if(!currentBookForDrink) return;
            const title = currentBookForDrink.title;
            // æ£€æŸ¥æ˜¯å¦åœ¨ä»»ä¸€ç»„
            let foundInGroup = null;
            for(let g in favoriteGroups) {
                if(favoriteGroups[g].includes(title)) {
                    foundInGroup = g;
                    break;
                }
            }

            if(foundInGroup) {
                // å·²æ”¶è— -> å–æ¶ˆæ”¶è— (ä»è¯¥ç»„ç§»é™¤)
                const idx = favoriteGroups[foundInGroup].indexOf(title);
                favoriteGroups[foundInGroup].splice(idx, 1);
            } else {
                // æœªæ”¶è— -> åŠ å…¥é»˜è®¤ç»„
                if(!favoriteGroups["é»˜è®¤æ”¶è—"]) favoriteGroups["é»˜è®¤æ”¶è—"] = [];
                favoriteGroups["é»˜è®¤æ”¶è—"].push(title);
            }
            
            saveCloudData();
            updateFavIconState();
            if(currentBarTab === 'fav') renderFavorites(); 
        }

        function updateFavIconState() {
            const btn = document.getElementById('btn-fav');
            if(currentBookForDrink && favoriteDrinks.includes(currentBookForDrink.title)) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        }

        function toggleSidebar() {
            const wrapper = document.getElementById('control-panel-wrapper');
            const btn = document.getElementById('toggle-sidebar-btn');
            wrapper.classList.toggle('collapsed');
            btn.innerHTML = wrapper.classList.contains('collapsed') ? 'â—€' : 'â–¶';
            setTimeout(() => { myChart.resize(); }, 350); 
        }

        function toggleMysteryMode() {
            isMysteryMode = document.getElementById('mystery-toggle').checked;
            document.body.classList.toggle('mystery-mode', isMysteryMode);
            updateUI(document.getElementById('country-select').value);
        }

        function toggleBarMode() {
            isBarMode = document.getElementById('bar-toggle').checked;
            document.body.classList.toggle('bar-mode', isBarMode);
            if(!isBarMode) setTimeout(() => myChart.resize(), 100);
        }

        function openBarForBook(country, index) {
            document.getElementById('bar-toggle').checked = true;
            toggleBarMode();
            const book = getBookObject(myBookData[country][index]);
            showDrinkCard(book);
        }

        function filterList() {
            const selected = document.getElementById('country-select').value;
            updateUI(selected);
        }

        function updateUI(filterCountry = "") {
            const listContainer = document.getElementById('book-list-display');
            listContainer.innerHTML = '';
            let displayData = {};
            for (let c in myBookData) {
                let books = myBookData[c].map(b => getBookObject(b));
                if (isMysteryMode) books = books.filter(b => b.isMystery);
                if (books.length > 0) displayData[c] = books;
            }
            if (Object.keys(displayData).length === 0) {
                listContainer.innerHTML = `<div style="text-align:center;color:var(--text-light);margin-top:20px;font-size:13px;">æš‚æ— è®°å½•</div>`;
                renderMap(displayData, filterCountry);
                return;
            }
            const sortedCountries = Object.keys(displayData).sort((a,b) => displayData[b].length - displayData[a].length);
            for (let country of sortedCountries) {
                if (filterCountry && country !== filterCountry) continue;
                const div = document.createElement('div');
                div.className = 'country-item';
                let booksHtml = '';
                displayData[country].forEach((b, i) => {
                    let originalIndex = myBookData[country].findIndex(origin => getBookObject(origin).title === b.title);
                    let safeCountry = country.replace(/'/g, "\\'");
                    let coverHtml = b.cover ? `<img src="${b.cover}" class="book-cover">` : `<div class="book-cover" style="display:flex;align-items:center;justify-content:center;color:#ccc;font-size:20px;">ğŸ“–</div>`;
                    let tagHtml = b.isMystery ? `<span class="mystery-tag">ğŸ•µï¸</span>` : ``;
                    booksHtml += `
                        <div class="book-row">
                            ${coverHtml}
                            <div class="book-info">
                                <div class="book-title">${b.title} ${tagHtml}</div>
                                <div class="book-meta"><span>${b.author || 'æœªçŸ¥'}</span></div>
                            </div>
                            <div class="btn-group">
                                <span class="action-btn bar-btn" onclick="openBarForBook('${safeCountry}', ${originalIndex})">ğŸ¹</span>
                                <span class="action-btn edit-btn" onclick="editBook('${safeCountry}', ${originalIndex})">âœ</span>
                                <span class="action-btn delete-btn" onclick="deleteBook('${safeCountry}', ${originalIndex})">Ã—</span>
                            </div>
                        </div>`;
                });
                div.innerHTML = `<div class="country-head"><span>${country}</span><span style="color:var(--primary-color)">${displayData[country].length}</span></div>${booksHtml}`;
                listContainer.appendChild(div);
            }
            renderMap(displayData, filterCountry);
        }

        function getBookObject(item) {
            if (typeof item === 'string') return { title: item, author: "", cover: "", isMystery: false };
            return item;
        }

        function addBook() {
            const country = document.getElementById('country-select').value;
            const bookName = document.getElementById('book-name').value.trim();
            if (!country) { alert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå›½å®¶"); return; }
            if (!bookName) { alert("è¯·è¾“å…¥ä¹¦å"); return; }
            const btn = document.getElementById('add-btn');
            btn.disabled = true; btn.innerText = "ğŸ” æœå¯»ä¸­...";
            fetch(`https://www.googleapis.com/books/v1/volumes?q=intitle:${encodeURIComponent(bookName)}&langRestrict=zh&maxResults=1`)
                .then(response => response.json()).then(data => {
                    let newBook = { title: bookName, author: "æœªçŸ¥ä½œè€…", cover: "", isMystery: false }; 
                    if (data.items && data.items.length > 0) {
                        const info = data.items[0].volumeInfo;
                        const apiTitle = info.title || "";
                        if (apiTitle.includes(bookName)) {
                            newBook.title = info.title || bookName;
                            newBook.author = (info.authors && info.authors.length > 0) ? info.authors[0] : "æœªçŸ¥ä½œè€…";
                            newBook.cover = (info.imageLinks && info.imageLinks.smallThumbnail) ? info.imageLinks.smallThumbnail : "";
                            const categories = info.categories || [];
                            const description = info.description || "";
                            const title = info.title || "";
                            const mysteryKeywords = ["Mystery", "Detective", "Crime", "Thriller", "Suspense", "Noir", "æ¨ç†", "æ‚¬ç–‘", "ä¾¦æ¢", "å‡¶æ€", "è§£è°œ", "æ¢æ¡ˆ", "æƒŠæ‚š", "çŠ¯ç½ª"];
                            newBook.isMystery = mysteryKeywords.some(keyword => {
                                return categories.some(c => c.includes(keyword)) || title.includes(keyword) || description.includes(keyword);
                            });
                        }
                    }
                    if (!myBookData[country]) myBookData[country] = [];
                    myBookData[country].push(newBook);
                    document.getElementById('book-name').value = '';
                    btn.disabled = false; btn.innerText = "âœ¨ æ™ºèƒ½è®°å½•";
                    saveCloudData(); 
                    filterList(); 
                })
                .catch(err => {
                    if (!myBookData[country]) myBookData[country] = [];
                    myBookData[country].push({ title: bookName, author: "", cover: "", isMystery: false });
                    document.getElementById('book-name').value = '';
                    btn.disabled = false; btn.innerText = "âœ¨ æ™ºèƒ½è®°å½•";
                    saveCloudData();
                    filterList();
                });
        }

        function editBook(country, index) {
            const bookObj = getBookObject(myBookData[country][index]);
            const newName = prompt("ğŸ“ ä¿®æ”¹ä¹¦å:", bookObj.title);
            if (newName === null) return;
            const newIsMystery = confirm(`è¿™æœ¬ä¹¦æ˜¯ã€æ‚¬ç–‘/æ¨ç†ã€‘ç±»å—ï¼Ÿ\n\nç‚¹å‡»â€œç¡®å®šâ€æ ‡è®°ä¸ºæ‚¬ç–‘ã€‚\nç‚¹å‡»â€œå–æ¶ˆâ€æ ‡è®°ä¸ºæ™®é€šã€‚`);
            const newCountry = prompt("ğŸŒ ä¿®æ”¹å›½å®¶ (å¦‚æœè¦ç§»åŠ¨è¯·ä¿®æ”¹):", country);
            if (newCountry === null) return;
            bookObj.title = newName;
            bookObj.isMystery = newIsMystery;
            if (newCountry !== country) {
                myBookData[country].splice(index, 1);
                if (myBookData[country].length === 0) delete myBookData[country];
                if (!myBookData[newCountry]) myBookData[newCountry] = [];
                myBookData[newCountry].push(bookObj);
            } else {
                myBookData[country][index] = bookObj;
            }
            saveCloudData();
            filterList();
        }

        function deleteBook(country, index) {
            const bookObj = getBookObject(myBookData[country][index]);
            if (confirm(`åˆ é™¤ã€Š${bookObj.title}ã€‹ï¼Ÿ`)) {
                myBookData[country].splice(index, 1);
                if (myBookData[country].length === 0) delete myBookData[country];
                saveCloudData();
                filterList();
            }
        }

        function updateCountryDropdown() {
            const select = document.getElementById('country-select');
            const currentSelected = select.value; 
            let sortedList = allCountryList.map(name => {
                return { name: name, count: (myBookData[name] && myBookData[name].length > 0) ? myBookData[name].length : 0 };
            });
            sortedList.sort((a, b) => {
                if (b.count !== a.count) return b.count - a.count;
                return a.name.localeCompare(b.name, 'zh');
            });
            select.innerHTML = '<option value="">-- æ˜¾ç¤ºå…¨éƒ¨ --</option>';
            [...sortedList.slice(0,5), ...sortedList.slice(5).sort((a,b)=>a.name.localeCompare(b.name,'zh'))].forEach(item => {
                const option = document.createElement('option');
                option.value = item.name;
                option.textContent = item.name; 
                select.appendChild(option);
            });
            if (currentSelected) select.value = currentSelected;
        }

        function renderMap(filteredData, highlightCountry = "") {
            if (!geoJsonData) return;
            const mapData = [];
            let maxBookCount = 0;
            const defaultAreaColor = isMysteryMode ? '#37474f' : '#f7fcf5';
            const defaultBorderColor = isMysteryMode ? '#546e7a' : '#eceff1';
            const hoverStyle = { shadowBlur: 15, shadowColor: 'rgba(0, 0, 0, 0.5)', shadowOffsetY: 8, shadowOffsetX: 4 };
            const selectedStyle = { areaColor: isMysteryMode ? '#7e57c2' : '#ffeb3b', borderColor: defaultBorderColor, borderWidth: 0.5, ...hoverStyle };
            for (let country in filteredData) {
                const count = filteredData[country].length;
                if (count > maxBookCount) maxBookCount = count;
                let itemStyle;
                if (highlightCountry && country === highlightCountry) { itemStyle = selectedStyle; } else { itemStyle = { areaColor: defaultAreaColor, borderColor: defaultBorderColor, borderWidth: 0.5 }; }
                mapData.push({ name: country, value: count, books: filteredData[country], itemStyle: itemStyle });
            }
            if (highlightCountry && !filteredData[highlightCountry]) { mapData.push({ name: highlightCountry, value: 0, books: [], itemStyle: selectedStyle }); }
            if (maxBookCount < 5) maxBookCount = 5;
            const forestColors = [{min: 50, label: '50+', color: '#005a32'}, {min: 20, max: 49, label: '20-49', color: '#238b45'}, {min: 10, max: 19, label: '10-19', color: '#41ab5d'}, {min: 5, max: 9, label: '5-9', color: '#74c476'}, {min: 1, max: 4, label: '1-4', color: '#bae4b3'}];
            const mysteryColors = [{min: 50, label: '50+', color: '#311b92'}, {min: 20, max: 49, label: '20-49', color: '#4527a0'}, {min: 10, max: 19, label: '10-19', color: '#673ab7'}, {min: 5, max: 9, label: '5-9', color: '#9575cd'}, {min: 1, max: 4, label: '1-4', color: '#d1c4e9'}];
            const option = {
                backgroundColor: 'transparent',
                visualMap: { type: 'piecewise', left: 'left', top: 'bottom', text: [isMysteryMode ? 'æ‚¬ç–‘å«é‡' : 'é˜…è¯»é‡', ''], pieces: isMysteryMode ? mysteryColors : forestColors, textStyle: { color: isMysteryMode ? '#b39ddb' : '#5d4037' }, },
                tooltip: {
                    trigger: 'item', backgroundColor: isMysteryMode ? 'rgba(50, 50, 50, 0.9)' : '#ffffff', borderColor: isMysteryMode ? '#9575cd' : '#74c476', borderWidth: 1, textStyle: { color: isMysteryMode ? '#fff' : '#37474f' },
                    formatter: (p) => {
                        if (!p.value) return p.name;
                        if (p.data && p.data.books && p.data.books.length > 0) {
                            let bookListStr = p.data.books.slice(0, 8).map(b=>'â€¢ '+b.title).join('<br/>');
                            if(p.data.books.length > 8) bookListStr += '<br/>...ç­‰ ' + p.data.books.length + ' æœ¬';
                            return `<div style="padding:5px;"><strong>${p.name}</strong><br/><span style="font-size:12px;opacity:0.8">å·²è¯»ï¼š${p.value}</span><br/>${bookListStr}</div>`;
                        }
                        return p.name;
                    }
                },
                series: [{ type: 'map', map: 'world', nameMap: nameMap, roam: true, zoom: 1.2, itemStyle: { areaColor: defaultAreaColor, borderColor: defaultBorderColor, borderWidth: 0.5 }, emphasis: { label: { show: true, color: isMysteryMode ? '#fff' : '#01579b', fontWeight: 'bold' }, itemStyle: hoverStyle }, data: mapData }]
            };
            myChart.setOption(option);
        }

        fetch('https://cdn.jsdelivr.net/npm/echarts@4.9.0/map/json/world.json')
            .then(res => res.json()).then(json => { 
                geoJsonData = json; 
                echarts.registerMap('world', json); 
                myChart.on('click', function(params) {
                    const select = document.getElementById('country-select');
                    select.value = params.name;
                    filterList();
                });
                const uniqueCountries = new Set(Object.values(nameMap));
                allCountryList = Array.from(uniqueCountries).sort((a, b) => a.localeCompare(b, 'zh'));
                loadCloudData(); 
            });
        window.addEventListener('resize', () => myChart.resize());
    </script>
</body>
</html>
