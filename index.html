<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æˆ‘çš„ä¸–ç•Œé˜…è¯»è®°å½• - èµ›åšå¤©ä½¿ä¿®æ­£ç‰ˆ</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=VT323&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <style>
        /* --- ğŸ¨ æ ¸å¿ƒé…è‰² --- */
        :root {
            --primary-color: #7cb342; 
            --bg-main: #cbe3f7;
            --bg-panel: #ffffff;
            --text-dark: #5d4037;      
            
            /* âœâš¡ èµ›åšå¤©ä½¿å˜é‡ */
            --fusion-bg: #0d0221;
            --fusion-pink: #ff00ff;
            --fusion-cyan: #00ffff;
            --fusion-purple: #bd00ff;
            --fusion-win-bg: #2a2a2a;
            --fusion-text: #e0e0e0;
            --font-title: 'Press Start 2P', cursive;
            --font-body: 'VT323', monospace;
            --retro-border-outset: 3px solid;
            --retro-border-color-outset: #ffffff #808080 #808080 #ffffff;
            --retro-border-inset: 3px solid;
            --retro-border-color-inset: #808080 #ffffff #ffffff #808080;
        }

        /* åŸºç¡€æ ·å¼ */
        body { margin: 0; padding: 0; background-color: var(--bg-main); font-family: "Microsoft YaHei", sans-serif; display: flex; height: 100vh; overflow: hidden; transition: background-color 0.5s ease; }
        #left-stage { flex: 1; position: relative; width: 100%; height: 100%; overflow: hidden; }
        #map-container { width: 100%; height: 100%; position: absolute; top:0; left:0; z-index: 1; transition: opacity 0.5s ease, transform 0.5s ease; opacity: 1; transform: scale(1); visibility: visible; }
        #main { width: 100%; height: 100%; }

        /* =========================================
           âœâš¡ UI å±‚
           ========================================= */
        #bar-interface {
            width: 100%; height: 100%; position: absolute; top:0; left:0; z-index: 10;
            background-color: var(--fusion-bg);
            background-image: 
                linear-gradient(rgba(189, 0, 255, 0.2) 1px, transparent 1px),
                linear-gradient(90deg, rgba(189, 0, 255, 0.2) 1px, transparent 1px);
            background-size: 30px 30px;
            display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
            opacity: 0; visibility: hidden; pointer-events: none; transform: scale(1.1);
            transition: all 0.2s steps(5);
            color: var(--fusion-text); padding-top: 40px; box-sizing: border-box;
            font-family: var(--font-body);
        }
        #bar-interface::before {
            content: " "; display: block; position: absolute; top: 0; left: 0; bottom: 0; right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            z-index: 2; background-size: 100% 2px, 3px 100%; pointer-events: none;
        }

        body.bar-mode #map-container { opacity: 0; transform: scale(0.9); visibility: hidden; }
        body.bar-mode #bar-interface { opacity: 1; visibility: visible; pointer-events: auto; transform: scale(1); }

        .cyber-window {
            background: var(--fusion-win-bg);
            border: 2px solid var(--fusion-pink);
            box-shadow: 6px 6px 0px rgba(0,255,255,0.3);
            position: relative; padding-top: 25px;
        }
        .cyber-window::before {
            content: 'â™¥ SYSTEM_OVERRIDE â™¥';
            position: absolute; top: 0; left: 0; right: 0; height: 22px;
            background: linear-gradient(90deg, var(--fusion-pink), var(--fusion-purple));
            color: white; font-family: var(--font-title); font-size: 10px;
            display: flex; align-items: center; padding-left: 5px;
            border-bottom: 2px solid var(--fusion-pink);
        }

        .bar-nav { display: flex; gap: 10px; margin-bottom: 30px; z-index: 20; }
        .bar-nav-item {
            padding: 8px 12px; background: #000; border: 2px solid var(--fusion-cyan); color: var(--fusion-cyan);
            cursor: pointer; font-family: var(--font-title); font-size: 12px; box-shadow: 3px 3px 0 var(--fusion-purple); transition: 0.1s;
        }
        .bar-nav-item.active { background: var(--fusion-pink); color: #fff; border-color: #fff; box-shadow: 3px 3px 0 #fff; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        .bar-content { width: 100%; flex: 1; display: flex; flex-direction: column; align-items: center; overflow-y: auto; position: relative; z-index: 5; padding-bottom: 100px;}
        .bar-view { display: none; width: 100%; flex-direction: column; align-items: center; width: 90%; }
        .bar-view.active { display: flex; }

        .neon-sign {
            font-family: var(--font-title); font-size: 2rem; color: #fff;
            text-shadow: 4px 0 var(--fusion-pink), -4px 0 var(--fusion-cyan);
            margin-bottom: 15px; text-align: center; line-height: 1.5; animation: glitchText 0.3s infinite;
        }
        @keyframes glitchText { 0% { transform: skew(0deg); } 20% { transform: skew(-2deg); } 40% { transform: skew(2deg); } 60% { transform: skew(-1deg); } 80% { transform: skew(1deg); } 100% { transform: skew(0deg); } }

        .random-btn {
            margin-top: 30px; width: 200px; height: 80px; background: #000; border: 4px solid var(--fusion-pink);
            box-shadow: 0 0 20px var(--fusion-pink), inset 0 0 20px var(--fusion-pink);
            color: var(--fusion-pink); font-family: var(--font-title); font-size: 14px; cursor: pointer;
            transition: all 0.1s; position: relative; overflow: hidden; text-transform: uppercase;
        }
        .random-btn::before { content: ">> INJECT <<"; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 2; }
        .random-btn:hover { background: var(--fusion-pink); color: #fff; box-shadow: 0 0 40px var(--fusion-pink); }
        .random-btn:active { transform: scale(0.95); }

        .filter-group {
            background: rgba(0, 0, 0, 0.8); border: 1px solid var(--fusion-cyan);
            box-shadow: 5px 5px 0 var(--fusion-purple); position: relative; padding: 20px; margin-bottom: 20px; width: 100%; box-sizing: border-box;
        }
        .filter-title { color: var(--fusion-pink); font-family: var(--font-title); font-size: 12px; margin-bottom: 10px; display: block; border-bottom: 1px dashed var(--fusion-cyan); padding-bottom: 5px; }
        .filter-options { display: flex; gap: 8px; flex-wrap: wrap; }
        .filter-opt { padding: 5px 10px; border: 1px solid #555; background: #111; cursor: pointer; color: #aaa; transition: 0.2s; font-family: var(--font-body); font-size: 18px; }
        .filter-opt.selected { background: var(--fusion-cyan); color: #000; border-color: var(--fusion-cyan); font-weight: bold; }

        .produce-btn {
            width: 100%; padding: 15px; background: linear-gradient(90deg, #b00b69, #4b0082);
            border: 2px solid #fff; color: #fff; font-family: var(--font-title); font-size: 14px;
            cursor: pointer; margin-top: 15px; box-shadow: 0 0 15px rgba(255,255,255,0.5); text-shadow: 2px 2px 0 #000; 
        }

        .fav-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 15px; width: 100%; padding: 0; }
        .fav-item {
            background: rgba(0,0,0,0.5); border: 1px solid var(--fusion-cyan); padding: 15px;
            cursor: pointer; transition: 0.2s; display: flex; flex-direction: column; align-items: center;
        }
        .fav-icon { font-size: 32px; margin-bottom: 5px; }
        .fav-name { font-size: 16px; font-weight: bold; overflow: hidden; text-overflow: ellipsis; width: 100%; white-space: nowrap; font-family: var(--font-body);}

        /* é¥®å“å¡ */
        .drink-card-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(2px);
            display: flex; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s; z-index: 50;
        }
        .drink-card-overlay.show { opacity: 1; pointer-events: auto; }
        
        .drink-card {
            background: #c0c0c0; width: 400px; max-width: 90%; padding: 40px 20px 20px 20px;
            border-top: 2px solid #fff; border-left: 2px solid #fff;
            border-bottom: 2px solid #000; border-right: 2px solid #000;
            box-shadow: 15px 15px 0px rgba(0,0,0,0.5);
            position: relative; text-align: center; color: #000;
            transform: scale(0.8); opacity: 0; transition: all 0.3s;
            font-family: var(--font-body); border: 4px solid red;
            max-height: 85vh; overflow-y: auto;
        }
        .drink-card-overlay.show .drink-card { transform: scale(1); opacity: 1; }
        .drink-card::before {
            content: 'ERROR: DRINK_FOUND'; position: absolute; top: 4px; left: 4px; right: 4px; height: 25px;
            background: navy; color: white; font-family: var(--font-body); font-weight: bold; font-size: 16px;
            display: flex; align-items: center; padding-left: 5px;
        }

        .card-close { position: absolute; top: 6px; right: 6px; width: 20px; height: 20px; background: #c0c0c0; border: 1px solid #000; text-align: center; cursor: pointer; color: #000; z-index: 2; font-weight: bold; line-height: 18px;}
        .card-glass-icon { font-size: 70px; margin: 10px 0; display: inline-block; filter: drop-shadow(4px 4px 0 var(--fusion-pink)); }
        .card-title { font-family: var(--font-title); font-size: 16px; margin-bottom: 5px; color: #000; text-shadow: 2px 2px 0 #fff; line-height: 1.4; }
        .card-subtitle { font-size: 18px; color: var(--fusion-pink); margin-bottom: 15px; text-transform: uppercase; font-weight: bold; background: #000; display: inline-block; padding: 0 5px; }
        .card-section { text-align: left; margin-bottom: 10px; padding: 10px; border: 1px dotted #000; background: #fff; }
        .card-label { font-size: 14px; color: navy; font-weight: bold; margin-bottom: 4px; display: block; font-family: var(--font-body); text-decoration: underline; }
        .card-text { font-size: 18px; color: #000; line-height: 1.2; outline: none; }
        .tag-pill { display: inline-block; padding: 2px 6px; background: #000; color: var(--fusion-cyan); font-size: 14px; margin-right: 5px; margin-top: 5px; font-family: var(--font-body); }
        .card-actions { position: absolute; top: 35px; left: 20px; display: flex; gap: 8px; }
        .action-icon-btn { font-size: 18px; cursor: pointer; color: #000; background: #c0c0c0; border: 1px solid #fff; border-bottom: 1px solid #000; border-right: 1px solid #000; padding: 4px; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; }
        .action-icon-btn.active { background: #ffff00; } .action-icon-btn.saved { background: #00ff00; }

        /* åŠ¨ç”»å±‚ */
        #mixing-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: var(--fusion-bg); z-index: 60; display: flex; flex-direction: column; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
        #mixing-overlay.active { opacity: 1; pointer-events: auto; }
        .mixing-bowl { width: 150px; height: 150px; position: relative; margin-bottom: 40px; }
        .mixing-bowl::before { content: 'ğŸ’Š'; font-size: 100px; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); animation: spin3D 1s infinite linear; }
        @keyframes spin3D { 0% { transform: translate(-50%, -50%) rotate(0deg) scale(1); } 50% { transform: translate(-50%, -50%) rotate(180deg) scale(1.2); } 100% { transform: translate(-50%, -50%) rotate(360deg) scale(1); } }
        .mix-progress-container { width: 80%; height: 20px; background: #c0c0c0; border: 2px solid #fff; border-bottom: 2px solid #000; border-right: 2px solid #000; position: relative; }
        .mix-progress-bar { height: 100%; width: 0%; background: navy; transition: width 0.1s steps(5); }
        .mix-text { color: var(--fusion-cyan); font-size: 20px; font-family: var(--font-body); margin-top: 10px; text-align: center; }
        #big-reveal-icon { font-size: 120px; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0); opacity: 0; filter: drop-shadow(5px 5px 0 #fff); color: var(--fusion-pink); transition: all 0.3s; }
        #big-reveal-icon.popping { opacity: 1; transform: translate(-50%, -50%) scale(1); }

        /* =========================================
           ğŸ–¥ï¸ ä¾§è¾¹æ /æ§åˆ¶å° (æ ·å¼)
           ========================================= */
        #control-panel-wrapper { 
            position: relative; flex: 0 0 360px; width: 360px; height: 100%; z-index: 100; 
            transition: all 0.3s ease-in-out; margin-right: 0; 
        }
        #control-panel-wrapper.collapsed { margin-right: -360px; }
        
        #control-panel-body { 
            width: 100%; height: 100%; background-color: var(--bg-panel); 
            box-shadow: -5px 0 20px rgba(0, 0, 0, 0.1); padding: 30px; 
            box-sizing: border-box; display: flex; flex-direction: column; overflow: hidden; 
        }

        /* æŒ‰é’®åœ¨PCä¸Šçš„é»˜è®¤æ ·å¼ */
        #toggle-sidebar-btn { 
            position: absolute; left: -24px; top: 50%; transform: translateY(-50%); 
            width: 24px; height: 60px; background-color: var(--bg-panel); 
            border: 1px solid var(--border-color); border-right: none; 
            border-radius: 8px 0 0 8px; cursor: pointer; 
            display: flex; align-items: center; justify-content: center; 
            color: var(--primary-color); box-shadow: -2px 0 5px rgba(0,0,0,0.05); z-index: 101; 
        }

        /* =========================================
           ğŸ“± ç§»åŠ¨ç«¯é€‚é… (æ ¸å¿ƒä¿®å¤)
           ========================================= */
        @media (max-width: 768px) {
            body { flex-direction: column; overflow: hidden; }
            #left-stage { width: 100%; height: 100vh; flex: none; }
            
            /* 1. æ§åˆ¶é¢æ¿æ”¹ä¸ºåº•éƒ¨æŠ½å±‰ï¼Œå¹³æ—¶éšè— */
            #control-panel-wrapper {
                position: fixed; bottom: 0; left: 0; width: 100%; height: 85vh;
                margin-right: 0; z-index: 2000;
                transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
                transform: translateY(0); /* æ¿€æ´»çŠ¶æ€ï¼šæ˜¾ç¤º */
            }
            /* æ”¶èµ·çŠ¶æ€ï¼šå‘ä¸‹ç§»å‡ºå±å¹• */
            #control-panel-wrapper.collapsed {
                margin-right: 0; transform: translateY(110%);
            }
            
            #control-panel-body {
                border-radius: 20px 20px 0 0; padding: 20px;
                border-top: 4px solid var(--fusion-pink);
            }

            /* 2. æŒ‰é’®æ”¹ä¸ºå³ä¸‹è§’æ‚¬æµ® (FAB)ï¼Œä¸”è„±ç¦» Wrapper çš„å¸ƒå±€æµé™åˆ¶ */
            /* æ³¨æ„ï¼šæˆ‘ä»¬åœ¨ HTML ä¸­æŠŠæŒ‰é’®ç§»åˆ°äº† Wrapper å¤–é¢ï¼Œæ‰€ä»¥è¿™é‡Œç›´æ¥å®šä½äºå±å¹•å³ä¸‹è§’ */
            #toggle-sidebar-btn {
                position: fixed; bottom: 30px; right: 25px; 
                left: auto; top: auto; transform: none !important;
                width: 60px; height: 60px; border-radius: 50%; font-size: 24px;
                background: #000; border: 2px solid var(--fusion-cyan); 
                box-shadow: 0 0 15px var(--fusion-pink);
                color: transparent; z-index: 2001;
            }
            /* æŒ‰é’®å›¾æ ‡çŠ¶æ€ */
            #toggle-sidebar-btn.btn-expanded::before { content: "â–¼"; color: var(--fusion-cyan); font-size: 24px; }
            #toggle-sidebar-btn:not(.btn-expanded)::before { content: "â–²"; color: var(--fusion-cyan); font-size: 24px; }
        }
    </style>
</head>
<body>
    <div id="loading-mask">
        <div class="spinner"></div>
        <div id="loading-text">Downloading Angel.exe...</div>
    </div>

    <div id="left-stage">
        <div id="map-container"><div id="main"></div></div>
        
        <div id="bar-interface">
            <div id="mixing-overlay">
                <div class="mixing-bowl">
                    <div class="mix-progress-container"><div class="mix-progress-bar" id="mix-bar"></div></div>
                </div>
                <div class="mix-text" id="mix-text">CONNECTING...</div>
                <div id="big-reveal-icon"></div>
            </div>

            <div class="bar-nav">
                <div class="bar-nav-item active" onclick="switchBarTab('random')">â™¥ GACHA â™¥</div>
                <div class="bar-nav-item" onclick="switchBarTab('filter')">âš™ï¸ CONFIG</div>
                <div class="bar-nav-item" onclick="switchBarTab('fav')">ğŸ“ LOGS</div>
            </div>

            <div class="bar-content">
                <div id="view-random" class="bar-view active" style="text-align: center;">
                    <div class="neon-sign">âœ CYBER<br>ANGEL BAR âœ</div>
                    <div style="color:var(--fusion-pink); margin-bottom:30px; font-family:var(--font-body); font-size: 22px; font-weight: bold; text-shadow: 1px 1px #fff;">"Is this reality or just another stream?"</div>
                    <button class="random-btn" onclick="serveRandomDrink()">ğŸ’Š OVERDOSE ğŸ’Š</button>
                </div>

                <div id="view-filter" class="bar-view">
                    <div class="filter-group cyber-window">
                        <span class="filter-title">BASE_SPIRIT.exe</span>
                        <div class="filter-options" id="opt-base">
                            <div class="filter-opt selected" onclick="selectOpt(this, 'base', 'any')">ALL</div>
                            <div class="filter-opt" onclick="selectOpt(this, 'base', 'Gin')">GIN</div>
                            <div class="filter-opt" onclick="selectOpt(this, 'base', 'Whiskey')">WHISKY</div>
                            <div class="filter-opt" onclick="selectOpt(this, 'base', 'Rum')">RUM</div>
                            <div class="filter-opt" onclick="selectOpt(this, 'base', 'Vodka')">VODKA</div>
                            <div class="filter-opt" onclick="selectOpt(this, 'base', 'Tequila')">TEQ</div>
                        </div>
                    </div>
                    <div class="filter-group cyber-window">
                        <span class="filter-title">FLAVOR_MATRIX.dll</span>
                        <div class="filter-options" id="opt-taste">
                            <div class="filter-opt selected" onclick="selectOpt(this, 'taste', 'any')">VOID</div>
                            <div class="filter-opt" onclick="selectOpt(this, 'taste', 'sour')">SOUR</div>
                            <div class="filter-opt" onclick="selectOpt(this, 'taste', 'sweet')">SWEET</div>
                            <div class="filter-opt" onclick="selectOpt(this, 'taste', 'bitter')">BITTER</div>
                        </div>
                    </div>
                    <div class="filter-group cyber-window">
                        <span class="filter-title">STRESS_LEVEL</span>
                        <div class="filter-options" id="opt-strength">
                            <div class="filter-opt selected" onclick="selectOpt(this, 'strength', 'any')">RNG</div>
                            <div class="filter-opt" onclick="selectOpt(this, 'strength', 'light')">LOW</div>
                            <div class="filter-opt" onclick="selectOpt(this, 'strength', 'medium')">MID</div>
                            <div class="filter-opt" onclick="selectOpt(this, 'strength', 'strong')">HIGH</div>
                        </div>
                    </div>
                    <button class="produce-btn" onclick="serveFilteredDrink()">âš¡ STREAM START âš¡</button>
                </div>

                <div id="view-fav" class="bar-view">
                    <div class="fav-grid" id="fav-container"></div>
                </div>
            </div>
            
            <div class="drink-card-overlay" id="drink-overlay">
                <div class="drink-card" id="capture-target">
                    <div class="card-actions">
                        <button class="action-icon-btn" id="btn-fav" onclick="toggleFavorite()" title="Favorite">â˜…</button>
                        <button class="action-icon-btn" id="btn-save" onclick="saveCurrentCard()" title="Save">ğŸ’¾</button>
                        <button class="action-icon-btn" id="btn-download" onclick="downloadCard()" title="Download">ğŸ“¥</button>
                    </div>

                    <div class="card-close" onclick="closeDrinkCard()">X</div>
                    
                    <div class="card-glass-icon" id="card-icon">ğŸ¸</div>
                    <div class="card-title" id="card-title">Book Title</div>
                    <div class="card-subtitle" id="card-base">Base Spirit</div>
                    
                    <div class="card-section">
                        <span class="card-label">COMMENT.txt</span>
                        <div class="card-text" id="card-intro" contenteditable="true" spellcheck="false">...</div>
                        <div style="margin-top:5px;" id="card-tags"></div>
                    </div>
                    <div class="card-section">
                        <span class="card-label">INGREDIENTS.dat</span>
                        <div class="card-text" id="card-ingredients" contenteditable="true" spellcheck="false">...</div>
                    </div>
                    <div class="card-section">
                        <span class="card-label">PROTOCOL.log</span>
                        <div class="card-text" id="card-method" contenteditable="true" spellcheck="false">...</div>
                    </div>
                    <div style="font-size:14px; color:blue; margin-top:15px; font-weight:bold;">VESSEL TYPE: <span id="card-glass">...</span></div>
                </div>
            </div>
        </div>
    </div>

    <div id="toggle-sidebar-btn" class="btn-expanded" onclick="toggleSidebar()">â–¶</div>
    
    <div id="control-panel-wrapper">
        <div id="control-panel-body">
            <h2>ğŸŒ¿ é˜…è¯»è®°å½•</h2>
            <div class="mode-switch-container">
                <div class="switch-label"><span id="mode-icon">ğŸ•µï¸</span> <span>ä»…æ˜¾ç¤ºæ‚¬ç–‘</span></div>
                <label><input class="toggle-checkbox" type="checkbox" id="mystery-toggle" onchange="toggleMysteryMode()"><div class="toggle-slot"><div class="toggle-button"></div></div></label>
            </div>
            <div class="mode-switch-container">
                <div class="switch-label"><span id="mode-icon">ğŸ¸</span> <span>èµ›åšå¤©ä½¿æ¨¡å¼</span></div>
                <label><input class="toggle-checkbox" type="checkbox" id="bar-toggle" onchange="toggleBarMode()"><div class="toggle-slot"><div class="toggle-button"></div></div></label>
            </div>
            <div class="input-group">
                <label>ğŸ“ åœ°åŒºç­›é€‰ / å½•å…¥</label>
                <select id="country-select" onchange="filterList()"></select>
            </div>
            <div class="input-group">
                <label>ğŸ“– ä¹¦å (æ™ºèƒ½åˆ†ç±»)</label>
                <input type="text" id="book-name" placeholder="è¾“å…¥ä¹¦å...">
            </div>
            <button id="add-btn" onclick="addBook()">âœ¨ æ™ºèƒ½è®°å½•</button>
            <div id="book-list-display"></div>
        </div>
    </div>

    <script>
        const BIN_ID = '6940072543b1c97be9efcbb6'; 
        const API_KEY = '$2a$10$NK41BeroKJUHwITABG5hSOUM2STrIJgPrdkrbHXwIWmI4pHlPR2da'; 

        const COCKTAIL_DB = [
            { id: 'negroni', base: 'Gin', profile: 'bitter', strength: 'strong', name: 'Negroni', glass: 'Rocks', intro: 'è‹¦ä¹å‚åŠçš„å¹³è¡¡ï¼Œå¦‚åŒå‘½è¿çš„ç©ç¬‘ã€‚', materials: '30ml é‡‘é…’, 30ml é‡‘å·´åˆ©, 30ml ç”œå‘³ç¾æ€', method: 'åŠ å†°æ…æ‹Œï¼Œé¥°ä»¥æ©™çš®ã€‚' },
            { id: 'old_fashioned', base: 'Whiskey', profile: 'bitter', strength: 'strong', name: 'Old Fashioned', glass: 'Rocks', intro: 'ç»å…¸æ°¸ä¸è¿‡æ—¶ï¼Œæ²‰ç¨³è€Œæ·±é‚ƒã€‚', materials: '45ml æ³¢æœ¬å¨å£«å¿Œ, 1å—æ–¹ç³–, 2æ»´è‹¦ç²¾', method: 'æ–¹ç³–æµ¸è‹¦ç²¾æ£ç¢ï¼ŒåŠ å†°åŠ é…’æ…æ‹Œã€‚' },
            { id: 'martini', base: 'Gin', profile: 'dry', strength: 'strong', name: 'Dry Martini', glass: 'Martini', intro: 'æç®€ä¸»ä¹‰çš„å†·å³»ï¼Œé”‹åˆ©å¦‚åˆ€ã€‚', materials: '60ml é‡‘é…’, 10ml å¹²å‘³ç¾æ€', method: 'åŠ å†°æ…æ‹Œè‡³æå†·ï¼Œæ»¤å…¥å†°å†»é…’æ¯ã€‚' },
            { id: 'margarita', base: 'Tequila', profile: 'sour', strength: 'medium', name: 'Margarita', glass: 'Coupe', intro: 'å’¸ä¸é…¸çš„äº¤ç»‡ï¼Œçƒ­çƒˆçš„æƒ…æ„Ÿçˆ†å‘ã€‚', materials: '45ml é¾™èˆŒå…°, 20ml å›åº¦, 20ml é’æŸ æ±, ç›', method: 'ç›è¾¹ï¼ŒåŠ å†°æ‘‡å’Œã€‚' },
            { id: 'whiskey_sour', base: 'Whiskey', profile: 'sour', strength: 'medium', name: 'Whiskey Sour', glass: 'Rocks', intro: 'æŸ”æ»‘çš„é…¸ç”œï¼ŒæŠšå¹³å†…å¿ƒçš„è¤¶çš±ã€‚', materials: '45ml å¨å£«å¿Œ, 20ml æŸ æª¬æ±, 15ml ç³–æµ†, è›‹ç™½', method: 'å¹²æ‘‡ååŠ å†°æ‘‡å’Œã€‚' },
            { id: 'daiquiri', base: 'Rum', profile: 'sour', strength: 'medium', name: 'Daiquiri', glass: 'Coupe', intro: 'æµ·æ˜å¨çš„æœ€çˆ±ï¼Œçº¯ç²¹çš„çƒ­å¸¦é£æš´ã€‚', materials: '60ml ç™½æœ—å§†, 25ml é’æŸ æ±, 15ml ç³–æµ†', method: 'åŠ å†°æ‘‡å’Œã€‚' },
            { id: 'mojito', base: 'Rum', profile: 'sweet', strength: 'light', name: 'Mojito', glass: 'Highball', intro: 'è–„è·çš„æ¸…å‡‰ï¼Œå¤æ—¥åˆåçš„ç™½æ—¥æ¢¦ã€‚', materials: '50ml ç™½æœ—å§†, è–„è·å¶, é’æŸ , ç³–, è‹æ‰“æ°´', method: 'æ£ç¢è–„è·é’æŸ ï¼ŒåŠ ç¢å†°æ…æ‹Œã€‚' },
            { id: 'aperol_spritz', base: 'Prosecco', profile: 'bitter', strength: 'light', name: 'Aperol Spritz', glass: 'Wine', intro: 'å¤•é˜³èˆ¬çš„æ©™è‰²ï¼Œè½»æ¾æ„‰æ‚¦çš„å¼€ç¯‡ã€‚', materials: '90ml èµ·æ³¡é…’, 60ml é˜¿ä½©ç½—, è‹æ‰“æ°´', method: 'æ»¡å†°ç›´è°ƒã€‚' },
            { id: 'godfather', base: 'Whiskey', profile: 'sweet', strength: 'strong', name: 'Godfather', glass: 'Rocks', intro: 'æä»çš„é¦™ç”œæ©ç›–äº†å¨å£«å¿Œçš„çƒˆã€‚', materials: '45ml è‹æ ¼å…°å¨å£«å¿Œ, 15ml æä»åˆ©å£é…’', method: 'åŠ å†°æ…æ‹Œã€‚' },
            { id: 'manhattan', base: 'Whiskey', profile: 'bitter', strength: 'strong', name: 'Manhattan', glass: 'Coupe', intro: 'åŸå¸‚çš„å¤œè‰²ï¼Œçº¢æ¨±æ¡ƒèˆ¬çš„è¯±æƒ‘ã€‚', materials: '50ml é»‘éº¦å¨å£«å¿Œ, 20ml ç”œå‘³ç¾æ€, è‹¦ç²¾', method: 'åŠ å†°æ…æ‹Œã€‚' },
            { id: 'cosmopolitan', base: 'Vodka', profile: 'sweet', strength: 'medium', name: 'Cosmopolitan', glass: 'Martini', intro: 'ç²‰çº¢è‰²çš„éƒ½ä¼šä¼ è¯´ï¼Œæ—¶å°šè€Œè¿·ç¦»ã€‚', materials: '45ml ä¼ç‰¹åŠ , 15ml å›åº¦, è”“è¶Šè“æ±, é’æŸ ', method: 'åŠ å†°æ‘‡å’Œã€‚' },
            { id: 'gin_tonic', base: 'Gin', profile: 'bitter', strength: 'medium', name: 'Gin & Tonic', glass: 'Highball', intro: 'å¥å®çš„è‹¦å‘³ï¼Œæ²»æ„ˆçµé­‚çš„è‰¯è¯ã€‚', materials: '45ml é‡‘é…’, é€šå®æ°´, é’æŸ è§’', method: 'ç›´è°ƒã€‚' },
            { id: 'long_island', base: 'Mixed', profile: 'sweet', strength: 'strong', name: 'Long Island Iced Tea', glass: 'Highball', intro: 'çœ‹ä¼¼æ— å®³çš„çº¢èŒ¶ï¼Œå®åˆ™æ··ä¹±çš„æ·±æ¸Šã€‚', materials: 'äº”å¤§åŸºé…’å„15ml, æŸ æª¬æ±, å¯ä¹', method: 'åŠ å†°æ‘‡å’Œåæ³¨æ»¡å¯ä¹ã€‚' },
            { id: 'bloody_mary', base: 'Vodka', profile: 'savory', strength: 'medium', name: 'Bloody Mary', glass: 'Highball', intro: 'ç•ªèŒ„ä¸é¦™æ–™çš„ç‹‚æ¬¢ï¼Œå¤æ‚çš„æ•‘èµã€‚', materials: '45ml ä¼ç‰¹åŠ , ç•ªèŒ„æ±, æŸ æª¬, è¾£é…±æ²¹, ç›èƒ¡æ¤’', method: 'æ»šæ³•è°ƒåˆ¶ã€‚' },
            { id: 'white_russian', base: 'Vodka', profile: 'sweet', strength: 'medium', name: 'White Russian', glass: 'Rocks', intro: 'ä¸æ»‘çš„å¥¶æ²¹ï¼Œæ…µæ‡’çš„å“²å­¦ã€‚', materials: '45ml ä¼ç‰¹åŠ , 20ml å’–å•¡åˆ©å£é…’, é²œå¥¶æ²¹', method: 'ç›´è°ƒï¼Œå¥¶æ²¹æ¼‚æµ®ã€‚' },
            { id: 'pina_colada', base: 'Rum', profile: 'sweet', strength: 'medium', name: 'PiÃ±a Colada', glass: 'Hurricane', intro: 'è èä¸æ¤°å¥¶ï¼Œé€ƒç¦»ç°å®çš„å€Ÿå£ã€‚', materials: '45ml æœ—å§†, æ¤°æµ†, è èæ±', method: 'åŠ å†°æ‘‡å’Œæˆ–æ…æ‹Œã€‚' }
        ];

        var myChart = echarts.init(document.getElementById('main'));
        var myBookData = {}; var geoJsonData = null; var allCountryList = []; 
        var isMysteryMode = false; var isBarMode = false;
        var currentBarTab = 'random'; var currentBookForDrink = null; var favoriteDrinks = []; 
        var filterState = { taste: 'any', strength: 'any', base: 'any' };
        var nameMap = { 'Afghanistan': 'é˜¿å¯Œæ±—', 'Albania': 'é˜¿å°”å·´å°¼äºš', 'Algeria': 'é˜¿å°”åŠåˆ©äºš', 'Andorra': 'å®‰é“å°”', 'Angola': 'å®‰å“¥æ‹‰', 'Antarctica': 'å—ææ´²', 'Antigua and Barb.': 'å®‰æç“œå’Œå·´å¸ƒè¾¾', 'Argentina': 'é˜¿æ ¹å»·', 'Armenia': 'äºšç¾å°¼äºš', 'Australia': 'æ¾³å¤§åˆ©äºš', 'Austria': 'å¥¥åœ°åˆ©', 'Azerbaijan': 'é˜¿å¡æ‹œç–†', 'Bahamas': 'å·´å“ˆé©¬', 'Bahrain': 'å·´æ—', 'Bangladesh': 'å­ŸåŠ æ‹‰å›½', 'Barbados': 'å·´å·´å¤šæ–¯', 'Belarus': 'ç™½ä¿„ç½—æ–¯', 'Belgium': 'æ¯”åˆ©æ—¶', 'Belize': 'ä¼¯åˆ©å…¹', 'Benin': 'è´å®', 'Bermuda': 'ç™¾æ…•å¤§', 'Bhutan': 'ä¸ä¸¹', 'Bolivia': 'ç»åˆ©ç»´äºš', 'Bosnia and Herz.': 'æ³¢é»‘', 'Botswana': 'åšèŒ¨ç“¦çº³', 'Brazil': 'å·´è¥¿', 'Brunei': 'æ–‡è±', 'Bulgaria': 'ä¿åŠ åˆ©äºš', 'Burkina Faso': 'å¸ƒåŸºçº³æ³•ç´¢', 'Burundi': 'å¸ƒéš†è¿ª', 'Cambodia': 'æŸ¬åŸ”å¯¨', 'Cameroon': 'å–€éº¦éš†', 'Canada': 'åŠ æ‹¿å¤§', 'Cape Verde': 'ä½›å¾—è§’', 'Central African Rep.': 'ä¸­éå…±å’Œå›½', 'Chad': 'ä¹å¾—', 'Chile': 'æ™ºåˆ©', 'China': 'ä¸­å›½', 'Colombia': 'å“¥ä¼¦æ¯”äºš', 'Comoros': 'ç§‘æ‘©ç½—', 'Congo': 'åˆšæœå…±å’Œå›½', 'Costa Rica': 'å“¥æ–¯è¾¾é»åŠ ', 'Croatia': 'å…‹ç½—åœ°äºš', 'Cuba': 'å¤å·´', 'Cyprus': 'å¡æµ¦è·¯æ–¯', 'Czech Rep.': 'æ·å…‹å…±å’Œå›½', 'CÃ´te d\'Ivoire': 'ç§‘ç‰¹è¿ªç“¦', 'Dem. Rep. Congo': 'åˆšæœæ°‘ä¸»å…±å’Œå›½', 'Dem. Rep. Korea': 'æœé²œ', 'Denmark': 'ä¸¹éº¦', 'Djibouti': 'å‰å¸ƒæ', 'Dominica': 'å¤šç±³å°¼å…‹', 'Dominican Rep.': 'å¤šç±³å°¼åŠ ', 'Ecuador': 'å„ç“œå¤šå°”', 'Egypt': 'åŸƒåŠ', 'El Salvador': 'è¨å°”ç“¦å¤š', 'Eq. Guinea': 'èµ¤é“å‡ å†…äºš', 'Eritrea': 'å„ç«‹ç‰¹é‡Œäºš', 'Estonia': 'çˆ±æ²™å°¼äºš', 'Ethiopia': 'åŸƒå¡ä¿„æ¯”äºš', 'Falkland Is.': 'ç¦å…‹å…°ç¾¤å²›', 'Fiji': 'æ–æµ', 'Finland': 'èŠ¬å…°', 'France': 'æ³•å›½', 'Fr. S. Antarctic Lands': 'æ³•å±å—åŠçƒå’Œå—æé¢†åœ°', 'Gabon': 'åŠ è“¬', 'Gambia': 'å†ˆæ¯”äºš', 'Georgia': 'æ ¼é²å‰äºš', 'Germany': 'å¾·å›½', 'Ghana': 'åŠ çº³', 'Greece': 'å¸Œè…Š', 'Greenland': 'æ ¼é™µå…°', 'Grenada': 'æ ¼æ—çº³è¾¾', 'Guatemala': 'å±åœ°é©¬æ‹‰', 'Guinea': 'å‡ å†…äºš', 'Guinea-Bissau': 'å‡ å†…äºšæ¯”ç»', 'Guyana': 'åœ­äºšé‚£', 'Haiti': 'æµ·åœ°', 'Honduras': 'æ´ªéƒ½æ‹‰æ–¯', 'Hungary': 'åŒˆç‰™åˆ©', 'Iceland': 'å†°å²›', 'India': 'å°åº¦', 'Indonesia': 'å°åº¦å°¼è¥¿äºš', 'Iran': 'ä¼Šæœ—', 'Iraq': 'ä¼Šæ‹‰å…‹', 'Ireland': 'çˆ±å°”å…°', 'Israel': 'ä»¥è‰²åˆ—', 'Italy': 'æ„å¤§åˆ©', 'Ivory Coast': 'ç§‘ç‰¹è¿ªç“¦', 'Jamaica': 'ç‰™ä¹°åŠ ', 'Japan': 'æ—¥æœ¬', 'Jordan': 'çº¦æ—¦', 'Kazakhstan': 'å“ˆè¨å…‹æ–¯å¦', 'Kenya': 'è‚¯å°¼äºš', 'Korea': 'éŸ©å›½', 'Kosovo': 'ç§‘ç´¢æ²ƒ', 'Kuwait': 'ç§‘å¨ç‰¹', 'Kyrgyzstan': 'å‰å°”å‰æ–¯æ–¯å¦', 'Lao PDR': 'è€æŒ', 'Latvia': 'æ‹‰è„±ç»´äºš', 'Lebanon': 'é»å·´å«©', 'Lesotho': 'è±ç´¢æ‰˜', 'Liberia': 'åˆ©æ¯”é‡Œäºš', 'Libya': 'åˆ©æ¯”äºš', 'Liechtenstein': 'åˆ—æ”¯æ•¦å£«ç™»', 'Lithuania': 'ç«‹é™¶å®›', 'Luxembourg': 'å¢æ£®å ¡', 'Madagascar': 'é©¬è¾¾åŠ æ–¯åŠ ', 'Malawi': 'é©¬æ‹‰ç»´', 'Malaysia': 'é©¬æ¥è¥¿äºš', 'Mali': 'é©¬é‡Œ', 'Malta': 'é©¬è€³ä»–', 'Mauritania': 'æ¯›é‡Œå¡”å°¼äºš', 'Mauritius': 'æ¯›é‡Œæ±‚æ–¯', 'Mexico': 'å¢¨è¥¿å“¥', 'Moldova': 'æ‘©å°”å¤šç“¦', 'Monaco': 'æ‘©çº³å“¥', 'Mongolia': 'è’™å¤', 'Montenegro': 'é»‘å±±', 'Morocco': 'æ‘©æ´›å“¥', 'Mozambique': 'è«æ¡‘æ¯”å…‹', 'Myanmar': 'ç¼…ç”¸', 'Namibia': 'çº³ç±³æ¯”äºš', 'Nepal': 'å°¼æ³Šå°”', 'Netherlands': 'è·å…°', 'New Zealand': 'æ–°è¥¿å…°', 'Nicaragua': 'å°¼åŠ æ‹‰ç“œ', 'Niger': 'å°¼æ—¥å°”', 'Nigeria': 'å°¼æ—¥åˆ©äºš', 'North Korea': 'æœé²œ', 'North Macedonia': 'åŒ—é©¬å…¶é¡¿', 'Norway': 'æŒªå¨', 'Oman': 'é˜¿æ›¼', 'Pakistan': 'å·´åŸºæ–¯å¦', 'Palestine': 'å·´å‹’æ–¯å¦', 'Panama': 'å·´æ‹¿é©¬', 'Papua New Guinea': 'å·´å¸ƒäºšæ–°å‡ å†…äºš', 'Paraguay': 'å·´æ‹‰åœ­', 'Peru': 'ç§˜é²', 'Philippines': 'è²å¾‹å®¾', 'Poland': 'æ³¢å…°', 'Portugal': 'è‘¡è„ç‰™', 'Puerto Rico': 'æ³¢å¤šé»å„', 'Qatar': 'å¡å¡”å°”', 'Romania': 'ç½—é©¬å°¼äºš', 'Russia': 'ä¿„ç½—æ–¯', 'Rwanda': 'å¢æ—ºè¾¾', 'S. Sudan': 'å—è‹ä¸¹', 'Samoa': 'è¨æ‘©äºš', 'Saudi Arabia': 'æ²™ç‰¹é˜¿æ‹‰ä¼¯', 'Senegal': 'å¡å†…åŠ å°”', 'Serbia': 'å¡å°”ç»´äºš', 'Seychelles': 'å¡èˆŒå°”', 'Sierra Leone': 'å¡æ‹‰åˆ©æ˜‚', 'Singapore': 'æ–°åŠ å¡', 'Slovakia': 'æ–¯æ´›ä¼å…‹', 'Slovenia': 'æ–¯æ´›æ–‡å°¼äºš', 'Solomon Is.': 'æ‰€ç½—é—¨ç¾¤å²›', 'Somalia': 'ç´¢é©¬é‡Œ', 'South Africa': 'å—é', 'South Korea': 'éŸ©å›½', 'South Sudan': 'å—è‹ä¸¹', 'Spain': 'è¥¿ç­ç‰™', 'Sri Lanka': 'æ–¯é‡Œå…°å¡', 'Sudan': 'è‹ä¸¹', 'Suriname': 'è‹é‡Œå—', 'Swaziland': 'æ–¯å¨å£«å…°', 'Sweden': 'ç‘å…¸', 'Switzerland': 'ç‘å£«', 'Syria': 'å™åˆ©äºš', 'Taiwan': 'ä¸­å›½', 'Tajikistan': 'å¡”å‰å…‹æ–¯å¦', 'Tanzania': 'å¦æ¡‘å°¼äºš', 'Thailand': 'æ³°å›½', 'Timor-Leste': 'ä¸œå¸æ±¶', 'Togo': 'å¤šå“¥', 'Tonga': 'æ±¤åŠ ', 'Trinidad and Tobago': 'ç‰¹ç«‹å°¼è¾¾å’Œå¤šå·´å“¥', 'Tunisia': 'çªå°¼æ–¯', 'Turkey': 'åœŸè€³å…¶', 'Turkmenistan': 'åœŸåº“æ›¼æ–¯å¦', 'Uganda': 'ä¹Œå¹²è¾¾', 'Ukraine': 'ä¹Œå…‹å…°', 'United Arab Emirates': 'é˜¿è”é…‹', 'United Kingdom': 'è‹±å›½', 'United States': 'ç¾å›½', 'Uruguay': 'ä¹Œæ‹‰åœ­', 'Uzbekistan': 'ä¹Œå…¹åˆ«å…‹æ–¯å¦', 'Vanuatu': 'ç“¦åŠªé˜¿å›¾', 'Venezuela': 'å§”å†…ç‘æ‹‰', 'Vietnam': 'è¶Šå—', 'West Bank': 'è¥¿å²¸', 'W. Sahara': 'è¥¿æ’’å“ˆæ‹‰', 'Yemen': 'ä¹Ÿé—¨', 'Zambia': 'èµæ¯”äºš', 'Zimbabwe': 'æ´¥å·´å¸ƒéŸ¦' };

        function loadCloudData() {
            fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, { headers: { 'X-Master-Key': API_KEY } })
            .then(res => res.json())
            .then(data => {
                let record = data.record;
                myBookData = (record.books || (!record.favorites && !record.books) ? record : {});
                if(!record.favorites && !record.books && Object.keys(record).length > 0) { myBookData = record; }
                if(record.favorites) favoriteDrinks = record.favorites;
                if(record.books) myBookData = record.books;
                updateUI();
                updateCountryDropdown(); 
                document.getElementById('loading-mask').style.display = 'none';
                setTimeout(() => myChart.resize(), 500);
            })
            .catch(err => { console.error(err); document.getElementById('loading-text').innerText = "åŠ è½½å¤±è´¥"; });
        }

        function saveCloudData() {
            const payload = { books: myBookData, favorites: favoriteDrinks };
            fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
                method: 'PUT', headers: { 'Content-Type': 'application/json', 'X-Master-Key': API_KEY },
                body: JSON.stringify(payload)
            }).then(res => res.json()).then(data => { console.log('Saved'); });
        }

        function getDrinkForBook(bookTitle, isMystery) {
            let seed = 0;
            for (let i = 0; i < bookTitle.length; i++) seed += bookTitle.charCodeAt(i);
            const lowerTitle = bookTitle.toLowerCase();
            let candidates = COCKTAIL_DB;
            if(isMystery || lowerTitle.includes('æ€') || lowerTitle.includes('æ­»') || lowerTitle.includes('è°œ')) {
                candidates = COCKTAIL_DB.filter(d => d.profile === 'bitter' || d.strength === 'strong');
            } else if(lowerTitle.includes('çˆ±') || lowerTitle.includes('æ¢¦') || lowerTitle.includes('å©š')) {
                candidates = COCKTAIL_DB.filter(d => d.profile === 'sweet');
            }
            if(candidates.length === 0) candidates = COCKTAIL_DB;
            return candidates[seed % candidates.length]; 
        }

        function switchBarTab(tab) {
            currentBarTab = tab;
            document.querySelectorAll('.bar-nav-item').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.bar-view').forEach(el => el.classList.remove('active'));
            const index = tab === 'random' ? 0 : tab === 'filter' ? 1 : 2;
            document.querySelectorAll('.bar-nav-item')[index].classList.add('active');
            document.getElementById('view-' + tab).classList.add('active');
            if(tab === 'fav') renderFavorites();
        }

        function selectOpt(el, type, val) {
            filterState[type] = val;
            el.parentElement.querySelectorAll('.filter-opt').forEach(d => d.classList.remove('selected'));
            el.classList.add('selected');
        }

        const MIX_PHRASES = ["æ­£åœ¨ç ”ç£¨æƒ…èŠ‚ç¢ç‰‡...", "æå–å­—é‡Œè¡Œé—´çš„ä¼ç¬”...", "æ³¨å…¥ä¸»è§’çš„çœ¼æ³ª...", "æ…æ‹Œæ‚¬ç–‘çš„è¿·é›¾...", "æ²‰æ·€æ—¶å…‰çš„ä½™éŸµ...", "æ­£åœ¨å†°é•‡å¤æ‚çš„çœŸç›¸...", "è°ƒå’Œç”œèœœä¸è‹¦æ¶©çš„ç»“å±€..."];

        function playMixingAnimation(book, drink) {
            const overlay = document.getElementById('mixing-overlay');
            const mixBar = document.getElementById('mix-bar');
            const mixText = document.getElementById('mix-text');
            const revealIcon = document.getElementById('big-reveal-icon');
            
            overlay.classList.add('active');
            mixBar.style.width = '0%';
            revealIcon.classList.remove('popping');
            revealIcon.innerHTML = getGlassIcon(drink.glass); 
            
            let progress = 0;
            const interval = setInterval(() => {
                progress += 5;
                mixBar.style.width = progress + '%';
                if(progress % 20 === 0) {
                    mixText.innerText = MIX_PHRASES[Math.floor(Math.random() * MIX_PHRASES.length)];
                }
                if(progress >= 100) {
                    clearInterval(interval);
                    mixText.innerText = "è°ƒ åˆ¶ å®Œ æˆ";
                    revealIcon.classList.add('popping');
                    setTimeout(() => {
                        overlay.classList.remove('active');
                        showDrinkCard(book, drink); 
                    }, 600); 
                }
            }, 80); 
        }

        function serveRandomDrink() {
            let allBooks = [];
            for(let c in myBookData) myBookData[c].forEach(b => allBooks.push(b));
            if(allBooks.length === 0) return alert("ä¹¦æ¶æ˜¯ç©ºçš„ï¼Œå…ˆå»è®°å½•å‡ æœ¬ä¹¦å§ï¼");
            const randomBook = allBooks[Math.floor(Math.random() * allBooks.length)];
            const bookObj = getBookObject(randomBook);
            const drink = getDrinkForBook(bookObj.title, bookObj.isMystery);
            playMixingAnimation(bookObj, drink);
        }

        function serveFilteredDrink() {
            let allBooks = [];
            for(let c in myBookData) myBookData[c].forEach(b => allBooks.push(getBookObject(b)));
            let validDrinks = COCKTAIL_DB.filter(d => {
                let matchTaste = filterState.taste === 'any' || d.profile === filterState.taste;
                let matchStrength = filterState.strength === 'any' || d.strength === filterState.strength;
                let matchBase = filterState.base === 'any' || d.base.toLowerCase() === filterState.base.toLowerCase();
                return matchTaste && matchStrength && matchBase;
            });
            if(validDrinks.length === 0) return alert("é…’å•ä¸­æ²¡æœ‰ç¬¦åˆè¿™ç§åˆé’»å£å‘³çš„é…æ–¹...");
            if(allBooks.length === 0) return alert("æ²¡æœ‰ä¹¦å¯åšé…’äº†ã€‚");
            const targetDrinkBase = validDrinks[Math.floor(Math.random() * validDrinks.length)];
            const randomBook = allBooks[Math.floor(Math.random() * allBooks.length)];
            playMixingAnimation(randomBook, targetDrinkBase);
        }

        function showDrinkCard(book, forcedDrink = null) {
            currentBookForDrink = book;
            document.getElementById('btn-save').classList.remove('saved'); 
            const drink = forcedDrink || getDrinkForBook(book.title, book.isMystery);
            let displayIntro = drink.intro;
            let displayIngredients = drink.materials;
            let displayMethod = drink.method;
            if (book.customDrink) {
                displayIntro = book.customDrink.intro || drink.intro;
                displayIngredients = book.customDrink.ingredients || drink.materials;
                displayMethod = book.customDrink.method || drink.method;
            }
            document.getElementById('card-title').innerText = book.title;
            document.getElementById('card-base').innerText = drink.base.toUpperCase() + ' BASE';
            document.getElementById('card-icon').innerText = getGlassIcon(drink.glass);
            document.getElementById('card-intro').innerText = displayIntro;
            document.getElementById('card-ingredients').innerText = displayIngredients;
            document.getElementById('card-method').innerText = displayMethod;
            document.getElementById('card-glass').innerText = drink.glass;
            let tags = `<span class="tag-pill">${drink.profile}</span><span class="tag-pill">${drink.strength}</span>`;
            if(book.isMystery) tags += `<span class="tag-pill" style="color:#ff00de">Mystery</span>`;
            document.getElementById('card-tags').innerHTML = tags;
            updateFavIconState();
            document.getElementById('drink-overlay').classList.add('show');
        }

        function saveCurrentCard() {
            if (!currentBookForDrink) return;
            const newIntro = document.getElementById('card-intro').innerText;
            const newIngredients = document.getElementById('card-ingredients').innerText;
            const newMethod = document.getElementById('card-method').innerText;
            let found = false;
            for (let country in myBookData) {
                const list = myBookData[country];
                for (let i = 0; i < list.length; i++) {
                    if (list[i].title === currentBookForDrink.title) {
                        if (!list[i].customDrink) list[i].customDrink = {};
                        list[i].customDrink.intro = newIntro;
                        list[i].customDrink.ingredients = newIngredients;
                        list[i].customDrink.method = newMethod;
                        currentBookForDrink.customDrink = list[i].customDrink;
                        found = true;
                        break;
                    }
                }
                if (found) break;
            }
            if (found) {
                saveCloudData();
                const btn = document.getElementById('btn-save');
                btn.classList.add('saved'); 
                setTimeout(() => { btn.classList.remove('saved'); }, 2000);
            } else {
                alert("ä¿å­˜å¤±è´¥ï¼šæœªæ‰¾åˆ°åŸå§‹ä¹¦ç±è®°å½•ã€‚");
            }
        }

        function downloadCard() {
            const card = document.getElementById('capture-target');
            const closeBtn = document.querySelector('.card-close');
            const actions = document.querySelector('.card-actions');
            closeBtn.style.display = 'none';
            actions.style.display = 'none';
            html2canvas(card, { backgroundColor: "#0a0a0a", scale: 2 }).then(canvas => {
                closeBtn.style.display = 'block';
                actions.style.display = 'flex';
                const link = document.createElement('a');
                link.download = `VA11-${currentBookForDrink.title}.png`;
                link.href = canvas.toDataURL();
                link.click();
            });
        }

        function closeDrinkCard() {
            document.getElementById('drink-overlay').classList.remove('show');
        }

        function getGlassIcon(glass) {
            if(glass === 'Martini') return 'ğŸ¸';
            if(glass === 'Rocks') return 'ğŸ¥ƒ';
            if(glass === 'Wine') return 'ğŸ·';
            if(glass === 'Coupe') return 'ğŸ¥‚';
            if(glass === 'Highball') return 'ğŸ¹';
            return 'ğŸº';
        }

        function toggleFavorite() {
            if(!currentBookForDrink) return;
            const title = currentBookForDrink.title;
            const idx = favoriteDrinks.indexOf(title);
            if(idx === -1) { favoriteDrinks.push(title); } else { favoriteDrinks.splice(idx, 1); }
            updateFavIconState();
            saveCloudData(); 
            if(currentBarTab === 'fav') renderFavorites(); 
        }

        function updateFavIconState() {
            const btn = document.getElementById('btn-fav');
            if(currentBookForDrink && favoriteDrinks.includes(currentBookForDrink.title)) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        }

        function renderFavorites() {
            const container = document.getElementById('fav-container');
            container.innerHTML = '';
            if(favoriteDrinks.length === 0) {
                container.innerHTML = '<div class="empty-tip">é…’çª–ç©ºç©ºå¦‚ä¹Ÿ...<br>å»ç‚¹ä¸€æ¯å¹¶æ”¶è—å§ã€‚</div>';
                return;
            }
            let allBooksMap = {};
            for(let c in myBookData) myBookData[c].forEach(b => allBooksMap[getBookObject(b).title] = getBookObject(b));
            favoriteDrinks.forEach(title => {
                const book = allBooksMap[title];
                if(book) {
                    const drink = getDrinkForBook(title, book.isMystery);
                    const div = document.createElement('div');
                    div.className = 'fav-item';
                    div.onclick = () => showDrinkCard(book);
                    div.innerHTML = `<div class="fav-icon">${getGlassIcon(drink.glass)}</div><div class="fav-name">${title}</div><div style="font-size:10px; color:#666;">${drink.base}</div>`;
                    container.appendChild(div);
                }
            });
        }

        // ä¿®æ”¹ï¼šæ›´æ–° toggleSidebar é€»è¾‘ï¼Œå¤„ç†æŒ‰é’®çŠ¶æ€
        function toggleSidebar() {
            const wrapper = document.getElementById('control-panel-wrapper');
            const btn = document.getElementById('toggle-sidebar-btn');
            
            wrapper.classList.toggle('collapsed');
            
            // åˆ‡æ¢æŒ‰é’®çš„å±•å¼€çŠ¶æ€ç±»ï¼Œç”¨äº CSS ä¼ªå…ƒç´ å›¾æ ‡åˆ‡æ¢
            if(wrapper.classList.contains('collapsed')) {
                btn.classList.remove('btn-expanded');
                // æ¡Œé¢ç‰ˆæ–‡å­—
                if(window.innerWidth > 768) btn.innerHTML = 'â—€';
            } else {
                btn.classList.add('btn-expanded');
                // æ¡Œé¢ç‰ˆæ–‡å­—
                if(window.innerWidth > 768) btn.innerHTML = 'â–¶';
            }
            
            setTimeout(() => { myChart.resize(); }, 350); 
        }

        function toggleMysteryMode() {
            isMysteryMode = document.getElementById('mystery-toggle').checked;
            document.body.classList.toggle('mystery-mode', isMysteryMode);
            updateUI(document.getElementById('country-select').value);
        }

        function toggleBarMode() {
            isBarMode = document.getElementById('bar-toggle').checked;
            document.body.classList.toggle('bar-mode', isBarMode);
            if(!isBarMode) setTimeout(() => myChart.resize(), 100);
        }

        function openBarForBook(country, index) {
            document.getElementById('bar-toggle').checked = true;
            toggleBarMode();
            const book = getBookObject(myBookData[country][index]);
            showDrinkCard(book);
        }

        function filterList() {
            const selected = document.getElementById('country-select').value;
            updateUI(selected);
        }

        function updateUI(filterCountry = "") {
            const listContainer = document.getElementById('book-list-display');
            listContainer.innerHTML = '';
            let displayData = {};
            for (let c in myBookData) {
                let books = myBookData[c].map(b => getBookObject(b));
                if (isMysteryMode) books = books.filter(b => b.isMystery);
                if (books.length > 0) displayData[c] = books;
            }
            if (Object.keys(displayData).length === 0) {
                listContainer.innerHTML = `<div style="text-align:center;color:var(--text-light);margin-top:20px;font-size:13px;">æš‚æ— è®°å½•</div>`;
                renderMap(displayData, filterCountry);
                return;
            }
            const sortedCountries = Object.keys(displayData).sort((a,b) => displayData[b].length - displayData[a].length);
            for (let country of sortedCountries) {
                if (filterCountry && country !== filterCountry) continue;
                const div = document.createElement('div');
                div.className = 'country-item';
                let booksHtml = '';
                displayData[country].forEach((b, i) => {
                    let originalIndex = myBookData[country].findIndex(origin => getBookObject(origin).title === b.title);
                    let safeCountry = country.replace(/'/g, "\\'");
                    let coverHtml = b.cover ? `<img src="${b.cover}" class="book-cover">` : `<div class="book-cover" style="display:flex;align-items:center;justify-content:center;color:#ccc;font-size:20px;">ğŸ“–</div>`;
                    let tagHtml = b.isMystery ? `<span class="mystery-tag">ğŸ•µï¸</span>` : ``;
                    booksHtml += `
                        <div class="book-row">
                            ${coverHtml}
                            <div class="book-info">
                                <div class="book-title">${b.title} ${tagHtml}</div>
                                <div class="book-meta"><span>${b.author || 'æœªçŸ¥'}</span></div>
                            </div>
                            <div class="btn-group">
                                <span class="action-btn bar-btn" onclick="openBarForBook('${safeCountry}', ${originalIndex})">ğŸ¸</span>
                                <span class="action-btn edit-btn" onclick="editBook('${safeCountry}', ${originalIndex})">âœ</span>
                                <span class="action-btn delete-btn" onclick="deleteBook('${safeCountry}', ${originalIndex})">Ã—</span>
                            </div>
                        </div>`;
                });
                div.innerHTML = `<div class="country-head"><span>${country}</span><span style="color:var(--primary-color)">${displayData[country].length}</span></div>${booksHtml}`;
                listContainer.appendChild(div);
            }
            renderMap(displayData, filterCountry);
        }

        function getBookObject(item) {
            if (typeof item === 'string') return { title: item, author: "", cover: "", isMystery: false };
            return item;
        }

        // åŠ è½½åœ°å›¾
        fetch('https://cdn.jsdelivr.net/npm/echarts@4.9.0/map/json/world.json')
            .then(res => res.json()).then(json => { 
                geoJsonData = json; 
                echarts.registerMap('world', json); 
                myChart.on('click', function(params) {
                    const select = document.getElementById('country-select');
                    select.value = params.name;
                    filterList();
                });
                const uniqueCountries = new Set(Object.values(nameMap));
                allCountryList = Array.from(uniqueCountries).sort((a, b) => a.localeCompare(b, 'zh'));
                loadCloudData(); 
            });
        
        window.addEventListener('resize', () => myChart.resize());
    </script>
</body>
</html>